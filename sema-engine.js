!function(e,t){e.getElementById("livereloadscript")||((t=e.createElement("script")).async=1,t.src="//"+(window.location.host||"localhost").split(":")[0]+":35729/livereload.js?snipver=1",t.id="livereloadscript",e.getElementsByTagName("head")[0].appendChild(t))}(window.document),function(e,t){"object"==typeof exports&&"undefined"!=typeof module?t(exports):"function"==typeof define&&define.amd?define(["exports"],t):t((e="undefined"!=typeof globalThis?globalThis:e||self)["sema-engine"]={})}(this,(function(exports){"use strict";class RingBuffer{static getStorageForCapacity(e,t){if(!t.BYTES_PER_ELEMENT)throw"Pass in a ArrayBuffer subclass";var o=8+(e+1)*t.BYTES_PER_ELEMENT;return new SharedArrayBuffer(o)}constructor(e,t){if(!ArrayBuffer.__proto__.isPrototypeOf(t)&&void 0!==t.BYTES_PER_ELEMENT)throw"Pass a concrete typed array class as second argument";this._type=t,this.capacity=(e.byteLength-8)/t.BYTES_PER_ELEMENT,this.buf=e,this.write_ptr=new Uint32Array(this.buf,0,1),this.read_ptr=new Uint32Array(this.buf,4,1),this.storage=new t(this.buf,8,this.capacity)}type(){return this._type.name}push(e){var t=Atomics.load(this.read_ptr,0),o=Atomics.load(this.write_ptr,0);if((o+1)%this._storage_capacity()==t)return 0;let r=Math.min(this._available_write(t,o),e.length),n=Math.min(this._storage_capacity()-o,r),i=r-n;return this._copy(e,0,this.storage,o,n),this._copy(e,n,this.storage,0,i),Atomics.store(this.write_ptr,0,(o+r)%this._storage_capacity()),r}pop(e){var t=Atomics.load(this.read_ptr,0),o=Atomics.load(this.write_ptr,0);if(o==t)return 0;let r=Math.min(this._available_read(t,o),e.length),n=Math.min(this._storage_capacity()-t,e.length),i=r-n;return this._copy(this.storage,t,e,0,n),this._copy(this.storage,0,e,n,i),Atomics.store(this.read_ptr,0,(t+r)%this._storage_capacity()),r}empty(){var e=Atomics.load(this.read_ptr,0);return Atomics.load(this.write_ptr,0)==e}full(){var e=Atomics.load(this.read_ptr,0);return(Atomics.load(this.write_ptr,0)+1)%this.capacity!=e}capacity(){return this.capacity-1}available_read(){var e=Atomics.load(this.read_ptr,0),t=Atomics.load(this.write_ptr,0);return this._available_read(e,t)}available_write(){var e=Atomics.load(this.read_ptr,0),t=Atomics.load(this.write_ptr,0);return this._available_write(e,t)}_available_read(e,t){return t>e?t-e:t+this._storage_capacity()-e}_available_write(e,t){let o=e-t-1;return t>=e&&(o+=this._storage_capacity()),o}_storage_capacity(){return this.capacity}_copy(e,t,o,r,n){for(var i=0;i<n;i++)o[r+i]=e[t+i]}}const getBase64=e=>{if(-1!==e.indexOf(";base64,")){var t=e.indexOf(";base64,")+8;return!!e.slice(t).match(/^([A-Za-z0-9+\/]{4})*([A-Za-z0-9+\/]{4}|[A-Za-z0-9+\/]{3}=|[A-Za-z0-9+\/]{2}==)$/)&&e.slice(t)}return!1},_keyStr="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=",removePaddingFromBase64=e=>64===Module.maxiTools._keyStr.indexOf(e.charAt(e.length-1))?e.substring(0,e.length-1):e,loadSampleToArray=(e,t,o,r)=>{var n=[],i=getBase64(o);if(i){var s=i.length/4*3,a=new ArrayBuffer(s);i=removePaddingFromBase64(removePaddingFromBase64(i));var l,c,p,u,g,d,m,h=parseInt(i.length/4*3,10),I=0,b=0;for(l=new Uint8Array(a),i=i.replace(/[^A-Za-z0-9\+\/\=]/g,""),I=0;I<h;I+=3)c=_keyStr.indexOf(i.charAt(b++))<<2|(g=_keyStr.indexOf(i.charAt(b++)))>>4,p=(15&g)<<4|(d=_keyStr.indexOf(i.charAt(b++)))>>2,u=(3&d)<<6|(m=_keyStr.indexOf(i.charAt(b++))),l[I]=c,64!==d&&(l[I+1]=p),64!==m&&(l[I+2]=u);e.decodeAudioData(a,(function(e){let o=e.getChannelData(0);void 0!==n&&void 0!==r&&r.port.postMessage({sample:t,buffer:o})}),(function(e){console.log("Error decoding source!")}))}else{var f=new XMLHttpRequest;f.addEventListener("load",(()=>console.log("The transfer is complete."))),f.open("GET",o,!0),f.responseType="arraybuffer",f.onload=function(){e.decodeAudioData(f.response,(function(e){let o=e.getChannelData(0);void 0!==n&&void 0!==r&&r.port.postMessage({sample:t,buffer:o})}),(function(e){console.log("Error decoding source!")}))},f.send()}return"Loading module"};class Event{constructor(e){this.eventName=e,this.callbacks=[]}registerCallback(e){this.callbacks.push(e)}unregisterCallback(e){const t=this.callbacks.indexOf(e);t>-1&&this.callbacks.splice(t,1)}emit(e){this.callbacks.slice(0).forEach((t=>{t(e)}))}}class Dispatcher{constructor(){this.events={}}dispatch(e,t){const o=this.events[e];o&&o.emit(t)}addEventListener(e,t){let o=this.events[e];o||(o=new Event(e),this.events[e]=o),o.registerCallback(t)}removeEventListener(e,t){const o=this.events[e];o&&o.callbacks.indexOf(t)>-1&&(o.unregisterCallback(t),0===o.callbacks.length&&delete this.events[e])}}class Engine{constructor(){if(Engine.instance)return Engine.instance;Engine.instance=this,this.analysers={},this.sharedArrayBuffers={},this.dispatcher=new Dispatcher,this.samplesLoaded=!1}addEventListener(e,t){if(!(this.dispatcher&&e&&t))throw new Error("Error adding event listener to Engine");this.dispatcher.addEventListener(e,t)}asyncPostToProcessor(e){if(!(e&&this.audioWorkletNode&&this.audioWorkletNode.port))throw new Error("Error async posting to processor");console.log("DEBUG:AudioEngine:onMessagingEventHandler:"),console.log(e),this.audioWorkletNode.port.postMessage(e)}createSharedBuffer(e,t,o){let r=RingBuffer.getStorageForCapacity(32*o,Float64Array),n=new RingBuffer(r,Float64Array);return this.audioWorkletNode.port.postMessage({func:"sab",value:r,ttype:t,channelID:e,blocksize:o}),this.sharedArrayBuffers[e]={sab:r,rb:n},r}pushSharedBuffer(e){let t=new RingBuffer(e.value,Float64Array);this.audioWorkletNode.port.postMessage({func:"sab",value:e.value,ttype:e.ttype,channelID:e.channelID,blocksize:e.blocksize}),this.sharedArrayBuffers[e.channelID]={sab:e.value,rb:t}}pushDataToSharedBuffer(e,t){if(!(e&&t&&(Array.isArray(t),1)))throw new Error("Error in function parameters");this.sharedArrayBuffers&&this.sharedArrayBuffers[e]&&this.sharedArrayBuffers[e].rb.push(t)}pollAnalyserData(e){if(void 0!==e){const t=new Uint8Array(e.fftSize),o=new Uint8Array(e.fftSize);return e.getByteTimeDomainData(t),e.getByteFrequencyData(o),{smoothingTimeConstant:e.smoothingTimeConstant,fftSize:e.fftSize,frequencyDataArray:o,timeDataArray:t}}}createAnalyser(e,t){if(void 0!==this.audioContext&&void 0!==e&&void 0!==t){let o=this.audioContext.createAnalyser();o.smoothingTimeConstant=.25,o.fftSize=256,o.minDecibels=-90,o.maxDecibels=-0,this.audioWorkletNode.connect(o);let r=-1,n={};this.analysers[e]={analyser:o,analyserFrameId:r,callback:t};const i=()=>(n=this.pollAnalyserData(this.analysers[e].analyser),this.analysers[e].callback(n),this.analysers[e].analyserFrameId=requestAnimationFrame(i),r);i()}else void 0===this.audioContext&&(this.analysers[e]={callback:t})}connectAnalysers(){Object.keys(this.analysers).map((e=>this.createAnalyser(e,this.analysers[e].callback)))}removeAnalyser(e){if(void 0!==this.audioContext&&void 0!==this.audioWorkletNode){void 0!==this.analysers[e.id]&&(cancelAnimationFrame(this.analysers[e.id].analyserFrameId),delete this.analysers[e.id])}}async init(e,t){if(e&&t&&new URL(t)){return this.audioContext,this.audioWorkletName=e,this.audioWorkletUrl=t,void 0===this.audioContext&&(this.audioContext=new AudioContext({latencyHint:"playback"})),!!await this.loadWorkletProcessorCode()&&(this.connectWorkletNode(),!0)}throw new Error("Name and valid URL required for AudioWorklet processor")}play(){if(void 0!==this.audioContext)return"suspended"!==this.audioContext.state?(this.stop(),!1):(this.audioContext.resume(),!0)}stop(){void 0!==this.audioWorkletNode&&this.audioContext.suspend()}stopAndRelease(){void 0!==this.audioWorkletNode&&(this.audioWorkletNode.disconnect(this.audioContext.destination),this.audioWorkletNode=void 0)}more(e){if(void 0!==this.audioWorkletNode){const t=this.audioWorkletNode.parameters.get(e);return t.value+=.5,console.log(e+": "+t.value),!0}return!1}less(e){if(void 0!==this.audioWorkletNode){const t=this.audioWorkletNode.parameters.get(e);return t.value-=.5,console.log(e+": "+t.value),!0}return!1}eval(e){return!(!this.audioWorkletNode||!this.audioWorkletNode.port)&&("suspended"===this.audioContext.state&&this.audioContext.resume(),this.audioWorkletNode.port.postMessage({eval:1,setup:e.setup,loop:e.loop}),!0)}sendClockPhase(e,t){void 0!==this.audioWorkletNode&&this.audioWorkletNode.port.postMessage({phase:e,i:t})}onAudioInputInit(e){this.audioContext.createMediaStreamSource(e).connect(this.audioWorkletNode)}onAudioInputFail(e){console.error(`ERROR:Engine:AudioInputFail: ${e.message} ${e.name}`)}async connectMediaStream(){const e=window.constraints={audio:!0,video:!1};navigator.mediaDevices.getUserMedia(e).then((e=>this.onAudioInputInit(e))).catch(this.onAudioInputFail)}async loadWorkletProcessorCode(){if(void 0===this.audioContext)return!1;try{await this.audioContext.audioWorklet.addModule(this.audioWorkletUrl)}catch(e){return console.error("ERROR:Engine:loadWorkletProcessorCode: AudioWorklet not supported in this browser: ",e.message),!1}try{return this.audioWorkletNode=new AudioWorkletNode(this.audioContext,this.audioWorkletName),this.audioWorkletNode.channelInterpretation="discrete",this.audioWorkletNode.channelCountMode="explicit",this.audioWorkletNode.channelCount=this.audioContext.destination.maxChannelCount,!0}catch(e){return console.error("ERROR:Engine:loadWorkletProcessorCode: Error on custom AudioWorklet node creation: ",e.message),!1}}connectWorkletNode(){if(void 0!==this.audioWorkletNode)try{this.audioContext.destination.channelInterpretation="discrete",this.audioContext.destination.channelCountMode="explicit",this.audioContext.destination.channelCount=this.audioContext.destination.maxChannelCount,this.audioWorkletNode.connect(this.audioContext.destination),this.audioWorkletNode.onprocessorerror=e=>console.error("ERROR:Engine: maxi-processor 'onprocess' error detected"),this.audioWorkletNode.onprocessorstatechange=e=>console.log("maxi-processor state change detected: "+audioWorkletNode.processorState),this.audioWorkletNode.port.onmessageerror=e=>console.error("ERROR:Engine: Error message from port: "+e.data),this.audioWorkletNode.port.onmessage=e=>this.onProcessorMessageHandler(e)}catch(e){console.error("ERROR:Engine: Error connecting WorkletNode: ",e.message)}}onProcessorMessageHandler(e){if(e&&e.data)if(e.data.rq&&"send"===e.data.rq)switch(e.data.ttype){case"ML":break;case"NET":this.peerNet.send(e.data.ch[0],e.data.value,e.data.ch[1])}else if(e.data.rq&&"buf"===e.data.rq)switch(e.data.ttype){case"ML":this.dispatcher.dispatch("onSharedBuffer",{sab:e.data.value,channelID:e.data.channelID,blocksize:e.data.blocksize})}}subscribeAsyncMessage(e){void 0!==e&&void 0!==this.audioWorkletNode&&(this.audioWorkletNode.port.onmessage=e)}loadSample(e,t){if(void 0===this.audioContext)throw"Audio Context is not initialised!";loadSampleToArray(this.audioContext,e,t,this.audioWorkletNode)}}var commonjsGlobal="undefined"!=typeof globalThis?globalThis:"undefined"!=typeof window?window:"undefined"!=typeof global?global:"undefined"!=typeof self?self:{};function createCommonjsModule(e){var t={exports:{}};return e(t,t.exports),t.exports}var nearley=createCommonjsModule((function(e){var t,o;t=commonjsGlobal,o=function(){function e(t,o,r){return this.id=++e.highestId,this.name=t,this.symbols=o,this.postprocess=r,this}function t(e,t,o,r){this.rule=e,this.dot=t,this.reference=o,this.data=[],this.wantedBy=r,this.isComplete=this.dot===e.symbols.length}function o(e,t){this.grammar=e,this.index=t,this.states=[],this.wants={},this.scannable=[],this.completed={}}function r(e,t){this.rules=e,this.start=t||this.rules[0].name;var o=this.byName={};this.rules.forEach((function(e){o.hasOwnProperty(e.name)||(o[e.name]=[]),o[e.name].push(e)}))}function n(){this.reset("")}function i(e,t,i){if(e instanceof r){var s=e;i=t}else s=r.fromCompiled(e,t);for(var a in this.grammar=s,this.options={keepHistory:!1,lexer:s.lexer||new n},i||{})this.options[a]=i[a];this.lexer=this.options.lexer,this.lexerState=void 0;var l=new o(s,0);this.table=[l],l.wants[s.start]=[],l.predict(s.start),l.process(),this.current=0}function s(e){var t=typeof e;if("string"===t)return e;if("object"===t){if(e.literal)return JSON.stringify(e.literal);if(e instanceof RegExp)return e.toString();if(e.type)return"%"+e.type;if(e.test)return"<"+String(e.test)+">";throw new Error("Unknown symbol type: "+e)}}return e.highestId=0,e.prototype.toString=function(e){var t=void 0===e?this.symbols.map(s).join(" "):this.symbols.slice(0,e).map(s).join(" ")+" ● "+this.symbols.slice(e).map(s).join(" ");return this.name+" → "+t},t.prototype.toString=function(){return"{"+this.rule.toString(this.dot)+"}, from: "+(this.reference||0)},t.prototype.nextState=function(e){var o=new t(this.rule,this.dot+1,this.reference,this.wantedBy);return o.left=this,o.right=e,o.isComplete&&(o.data=o.build(),o.right=void 0),o},t.prototype.build=function(){var e=[],t=this;do{e.push(t.right.data),t=t.left}while(t.left);return e.reverse(),e},t.prototype.finish=function(){this.rule.postprocess&&(this.data=this.rule.postprocess(this.data,this.reference,i.fail))},o.prototype.process=function(e){for(var t=this.states,o=this.wants,r=this.completed,n=0;n<t.length;n++){var s=t[n];if(s.isComplete){if(s.finish(),s.data!==i.fail){for(var a=s.wantedBy,l=a.length;l--;){var c=a[l];this.complete(c,s)}if(s.reference===this.index){var p=s.rule.name;(this.completed[p]=this.completed[p]||[]).push(s)}}}else{if("string"!=typeof(p=s.rule.symbols[s.dot])){this.scannable.push(s);continue}if(o[p]){if(o[p].push(s),r.hasOwnProperty(p)){var u=r[p];for(l=0;l<u.length;l++){var g=u[l];this.complete(s,g)}}}else o[p]=[s],this.predict(p)}}},o.prototype.predict=function(e){for(var o=this.grammar.byName[e]||[],r=0;r<o.length;r++){var n=o[r],i=this.wants[e],s=new t(n,0,this.index,i);this.states.push(s)}},o.prototype.complete=function(e,t){var o=e.nextState(t);this.states.push(o)},r.fromCompiled=function(t,o){var n=t.Lexer;t.ParserStart&&(o=t.ParserStart,t=t.ParserRules);var i=new r(t=t.map((function(t){return new e(t.name,t.symbols,t.postprocess)})),o);return i.lexer=n,i},n.prototype.reset=function(e,t){this.buffer=e,this.index=0,this.line=t?t.line:1,this.lastLineBreak=t?-t.col:0},n.prototype.next=function(){if(this.index<this.buffer.length){var e=this.buffer[this.index++];return"\n"===e&&(this.line+=1,this.lastLineBreak=this.index),{value:e}}},n.prototype.save=function(){return{line:this.line,col:this.index-this.lastLineBreak}},n.prototype.formatError=function(e,t){var o=this.buffer;if("string"==typeof o){var r=o.split("\n").slice(Math.max(0,this.line-5),this.line),n=o.indexOf("\n",this.index);-1===n&&(n=o.length);var i=this.index-this.lastLineBreak,s=String(this.line).length;return t+=" at line "+this.line+" col "+i+":\n\n",t+=r.map((function(e,t){return a(this.line-r.length+t+1,s)+" "+e}),this).join("\n"),t+="\n"+a("",s+i)+"^\n"}return t+" at index "+(this.index-1);function a(e,t){var o=String(e);return Array(t-o.length+1).join(" ")+o}},i.fail={},i.prototype.feed=function(e){var t,r=this.lexer;for(r.reset(e,this.lexerState);;){try{if(!(t=r.next()))break}catch(e){var i=new o(this.grammar,this.current+1);throw this.table.push(i),(l=new Error(this.reportLexerError(e))).offset=this.current,l.token=e.token,l}var s=this.table[this.current];this.options.keepHistory||delete this.table[this.current-1];var a=this.current+1;i=new o(this.grammar,a),this.table.push(i);for(var l,c=void 0!==t.text?t.text:t.value,p=r.constructor===n?t.value:t,u=s.scannable,g=u.length;g--;){var d=u[g],m=d.rule.symbols[d.dot];if(m.test?m.test(p):m.type?m.type===t.type:m.literal===c){var h=d.nextState({data:p,token:t,isToken:!0,reference:a-1});i.states.push(h)}}if(i.process(),0===i.states.length)throw(l=new Error(this.reportError(t))).offset=this.current,l.token=t,l;this.options.keepHistory&&(s.lexerState=r.save()),this.current++}return s&&(this.lexerState=r.save()),this.results=this.finish(),this},i.prototype.reportLexerError=function(e){var t,o,r=e.token;return r?(t="input "+JSON.stringify(r.text[0])+" (lexer error)",o=this.lexer.formatError(r,"Syntax error")):(t="input (lexer error)",o=e.message),this.reportErrorCommon(o,t)},i.prototype.reportError=function(e){var t=(e.type?e.type+" token: ":"")+JSON.stringify(void 0!==e.value?e.value:e),o=this.lexer.formatError(e,"Syntax error");return this.reportErrorCommon(o,t)},i.prototype.reportErrorCommon=function(e,t){var o=[];o.push(e);var r=this.table.length-2,n=this.table[r],i=n.states.filter((function(e){var t=e.rule.symbols[e.dot];return t&&"string"!=typeof t}));return 0===i.length?(o.push("Unexpected "+t+". I did not expect any more input. Here is the state of my parse table:\n"),this.displayStateStack(n.states,o)):(o.push("Unexpected "+t+". Instead, I was expecting to see one of the following:\n"),i.map((function(e){return this.buildFirstStateStack(e,[])||[e]}),this).forEach((function(e){var t=e[0],r=t.rule.symbols[t.dot],n=this.getSymbolDisplay(r);o.push("A "+n+" based on:"),this.displayStateStack(e,o)}),this)),o.push(""),o.join("\n")},i.prototype.displayStateStack=function(e,t){for(var o,r=0,n=0;n<e.length;n++){var i=e[n],s=i.rule.toString(i.dot);s===o?r++:(r>0&&t.push("    ^ "+r+" more lines identical to this"),r=0,t.push("    "+s)),o=s}},i.prototype.getSymbolDisplay=function(e){return function(e){var t=typeof e;if("string"===t)return e;if("object"===t){if(e.literal)return JSON.stringify(e.literal);if(e instanceof RegExp)return"character matching "+e;if(e.type)return e.type+" token";if(e.test)return"token matching "+String(e.test);throw new Error("Unknown symbol type: "+e)}}(e)},i.prototype.buildFirstStateStack=function(e,t){if(-1!==t.indexOf(e))return null;if(0===e.wantedBy.length)return[e];var o=e.wantedBy[0],r=[e].concat(t),n=this.buildFirstStateStack(o,r);return null===n?null:[e].concat(n)},i.prototype.save=function(){var e=this.table[this.current];return e.lexerState=this.lexerState,e},i.prototype.restore=function(e){var t=e.index;this.current=t,this.table[t]=e,this.table.splice(t+1),this.lexerState=e.lexerState,this.results=this.finish()},i.prototype.rewind=function(e){if(!this.options.keepHistory)throw new Error("set option `keepHistory` to enable rewinding");this.restore(this.table[e])},i.prototype.finish=function(){var e=[],t=this.grammar.start;return this.table[this.table.length-1].states.forEach((function(o){o.rule.name===t&&o.dot===o.rule.symbols.length&&0===o.reference&&o.data!==i.fail&&e.push(o)})),e.map((function(e){return e.data}))},{Parser:i,Grammar:r,Rule:e}},e.exports?e.exports=o():t.nearley=o()})),moo=createCommonjsModule((function(e){var t,o;t=commonjsGlobal,o=function(){var e=Object.prototype.hasOwnProperty,t=Object.prototype.toString,o="boolean"==typeof(new RegExp).sticky;function r(e){return e&&"[object RegExp]"===t.call(e)}function n(e){return e&&"object"==typeof e&&!r(e)&&!Array.isArray(e)}function i(e){return"("+e+")"}function s(e){return e.length?"(?:"+e.map((function(e){return"(?:"+e+")"})).join("|")+")":"(?!)"}function a(e){if("string"==typeof e)return"(?:"+e.replace(/[-\/\\^$*+?.()|[\]{}]/g,"\\$&")+")";if(r(e)){if(e.ignoreCase)throw new Error("RegExp /i flag not allowed");if(e.global)throw new Error("RegExp /g flag is implied");if(e.sticky)throw new Error("RegExp /y flag is implied");if(e.multiline)throw new Error("RegExp /m flag is implied");return e.source}throw new Error("Not a pattern: "+e)}function l(t,o){if(n(o)||(o={match:o}),o.include)throw new Error("Matching rules cannot also include states");var i={defaultType:t,lineBreaks:!!o.error||!!o.fallback,pop:!1,next:null,push:null,error:!1,fallback:!1,value:null,type:null,shouldThrow:!1};for(var s in o)e.call(o,s)&&(i[s]=o[s]);if("string"==typeof i.type&&t!==i.type)throw new Error("Type transform cannot be a string (type '"+i.type+"' for token '"+t+"')");var a=i.match;return i.match=Array.isArray(a)?a:a?[a]:[],i.match.sort((function(e,t){return r(e)&&r(t)?0:r(t)?-1:r(e)?1:t.length-e.length})),i}function c(e){return Array.isArray(e)?function(e){for(var t=[],o=0;o<e.length;o++){var r=e[o];if(r.include)for(var n=[].concat(r.include),i=0;i<n.length;i++)t.push({include:n[i]});else{if(!r.type)throw new Error("Rule has no type: "+JSON.stringify(r));t.push(l(r.type,r))}}return t}(e):function(e){for(var t=Object.getOwnPropertyNames(e),o=[],r=0;r<t.length;r++){var i=t[r],s=e[i],a=[].concat(s);if("include"!==i){var c=[];a.forEach((function(e){n(e)?(c.length&&o.push(l(i,c)),o.push(l(i,e)),c=[]):c.push(e)})),c.length&&o.push(l(i,c))}else for(var p=0;p<a.length;p++)o.push({include:a[p]})}return o}(e)}var p=l("error",{lineBreaks:!0,shouldThrow:!0});function u(e,t){for(var n=null,l=Object.create(null),c=!0,u=null,g=[],d=[],m=0;m<e.length;m++)e[m].fallback&&(c=!1);for(m=0;m<e.length;m++){var h=e[m];if(h.include)throw new Error("Inheritance is not allowed in stateless lexers");if(h.error||h.fallback){if(n)throw!h.fallback==!n.fallback?new Error("Multiple "+(h.fallback?"fallback":"error")+" rules not allowed (for token '"+h.defaultType+"')"):new Error("fallback and error are mutually exclusive (for token '"+h.defaultType+"')");n=h}var I=h.match.slice();if(c)for(;I.length&&"string"==typeof I[0]&&1===I[0].length;)l[I.shift().charCodeAt(0)]=h;if(h.pop||h.push||h.next){if(!t)throw new Error("State-switching options are not allowed in stateless lexers (for token '"+h.defaultType+"')");if(h.fallback)throw new Error("State-switching options are not allowed on fallback tokens (for token '"+h.defaultType+"')")}if(0!==I.length){c=!1,g.push(h);for(var b=0;b<I.length;b++){var f=I[b];if(r(f))if(null===u)u=f.unicode;else if(u!==f.unicode&&!1===h.fallback)throw new Error("If one rule is /u then all must be")}var C=s(I.map(a)),x=new RegExp(C);if(x.test(""))throw new Error("RegExp matches empty string: "+x);if(new RegExp("|"+C).exec("").length-1>0)throw new Error("RegExp has capture groups: "+x+"\nUse (?: … ) instead");if(!h.lineBreaks&&x.test("\n"))throw new Error("Rule should declare lineBreaks: "+x);d.push(i(C))}}var A=n&&n.fallback,y=o&&!A?"ym":"gm",w=o||A?"":"|";return!0===u&&(y+="u"),{regexp:new RegExp(s(d)+w,y),groups:g,fast:l,error:n||p}}function g(e,t,o){var r=e&&(e.push||e.next);if(r&&!o[r])throw new Error("Missing state '"+r+"' (in token '"+e.defaultType+"' of state '"+t+"')");if(e&&e.pop&&1!=+e.pop)throw new Error("pop must be 1 (in token '"+e.defaultType+"' of state '"+t+"')")}var d=function(e,t){this.startState=t,this.states=e,this.buffer="",this.stack=[],this.reset()};d.prototype.reset=function(e,t){return this.buffer=e||"",this.index=0,this.line=t?t.line:1,this.col=t?t.col:1,this.queuedToken=t?t.queuedToken:null,this.queuedThrow=t?t.queuedThrow:null,this.setState(t?t.state:this.startState),this.stack=t&&t.stack?t.stack.slice():[],this},d.prototype.save=function(){return{line:this.line,col:this.col,state:this.state,stack:this.stack.slice(),queuedToken:this.queuedToken,queuedThrow:this.queuedThrow}},d.prototype.setState=function(e){if(e&&this.state!==e){this.state=e;var t=this.states[e];this.groups=t.groups,this.error=t.error,this.re=t.regexp,this.fast=t.fast}},d.prototype.popState=function(){this.setState(this.stack.pop())},d.prototype.pushState=function(e){this.stack.push(this.state),this.setState(e)};var m=o?function(e,t){return e.exec(t)}:function(e,t){var o=e.exec(t);return 0===o[0].length?null:o};function h(){return this.value}if(d.prototype._getGroup=function(e){for(var t=this.groups.length,o=0;o<t;o++)if(void 0!==e[o+1])return this.groups[o];throw new Error("Cannot find token type for matched text")},d.prototype.next=function(){var e=this.index;if(this.queuedGroup){var t=this._token(this.queuedGroup,this.queuedText,e);return this.queuedGroup=null,this.queuedText="",t}var o=this.buffer;if(e!==o.length){if(s=this.fast[o.charCodeAt(e)])return this._token(s,o.charAt(e),e);var r=this.re;r.lastIndex=e;var n=m(r,o),i=this.error;if(null==n)return this._token(i,o.slice(e,o.length),e);var s=this._getGroup(n),a=n[0];return i.fallback&&n.index!==e?(this.queuedGroup=s,this.queuedText=a,this._token(i,o.slice(e,n.index),e)):this._token(s,a,e)}},d.prototype._token=function(e,t,o){var r=0;if(e.lineBreaks){var n=/\n/g,i=1;if("\n"===t)r=1;else for(;n.exec(t);)r++,i=n.lastIndex}var s={type:"function"==typeof e.type&&e.type(t)||e.defaultType,value:"function"==typeof e.value?e.value(t):t,text:t,toString:h,offset:o,lineBreaks:r,line:this.line,col:this.col},a=t.length;if(this.index+=a,this.line+=r,0!==r?this.col=a-i+1:this.col+=a,e.shouldThrow)throw new Error(this.formatError(s,"invalid syntax"));return e.pop?this.popState():e.push?this.pushState(e.push):e.next&&this.setState(e.next),s},"undefined"!=typeof Symbol&&Symbol.iterator){var I=function(e){this.lexer=e};I.prototype.next=function(){var e=this.lexer.next();return{value:e,done:!e}},I.prototype[Symbol.iterator]=function(){return this},d.prototype[Symbol.iterator]=function(){return new I(this)}}return d.prototype.formatError=function(e,t){if(null==e){var o=this.buffer.slice(this.index);e={text:o,offset:this.index,lineBreaks:-1===o.indexOf("\n")?0:1,line:this.line,col:this.col}}var r=Math.max(0,e.offset-e.col+1),n=e.lineBreaks?e.text.indexOf("\n"):e.text.length,i=this.buffer.substring(r,e.offset+n);return t+=" at line "+e.line+" col "+e.col+":\n\n",t+="  "+i+"\n",t+="  "+Array(e.col).join(" ")+"^"},d.prototype.clone=function(){return new d(this.states,this.state)},d.prototype.has=function(e){return!0},{compile:function(e){var t=u(c(e));return new d({start:t},"start")},states:function(e,t){var o=e.$all?c(e.$all):[];delete e.$all;var r=Object.getOwnPropertyNames(e);t||(t=r[0]);for(var n=Object.create(null),i=0;i<r.length;i++)n[C=r[i]]=c(e[C]).concat(o);for(i=0;i<r.length;i++)for(var s=n[C=r[i]],a=Object.create(null),l=0;l<s.length;l++){var p=s[l];if(p.include){var m=[l,1];if(p.include!==C&&!a[p.include]){a[p.include]=!0;var h=n[p.include];if(!h)throw new Error("Cannot include nonexistent state '"+p.include+"' (in state '"+C+"')");for(var I=0;I<h.length;I++){var b=h[I];-1===s.indexOf(b)&&m.push(b)}}s.splice.apply(s,m),l--}}var f=Object.create(null);for(i=0;i<r.length;i++){var C;f[C=r[i]]=u(n[C],!0)}for(i=0;i<r.length;i++){var x=r[i],A=f[x],y=A.groups;for(l=0;l<y.length;l++)g(y[l],x,f);var w=Object.getOwnPropertyNames(A.fast);for(l=0;l<w.length;l++)g(A.fast[w[l]],x,f)}return new d(f,t)},error:Object.freeze({error:!0}),fallback:Object.freeze({fallback:!0}),keywords:function(e){for(var t=Object.create(null),o=Object.create(null),r=Object.getOwnPropertyNames(e),n=0;n<r.length;n++){var i=r[n],s=e[i];(Array.isArray(s)?s:[s]).forEach((function(e){if((o[e.length]=o[e.length]||[]).push(e),"string"!=typeof e)throw new Error("keyword must be string (in keyword '"+i+"')");t[e]=i}))}function a(e){return JSON.stringify(e)}var l="";for(var c in l+="switch (value.length) {\n",o){var p=o[c];l+="case "+c+":\n",l+="switch (value) {\n",p.forEach((function(e){var o=t[e];l+="case "+a(e)+": return "+a(o)+"\n"})),l+="}\n"}return l+="}\n",Function("value",l)}}},e.exports?e.exports=o():t.moo=o()})),nearleyLanguageBootstrapped=createCommonjsModule((function(e){!function(){function t(e){return e[0]}function o(e){return e[0].value}var r=moo,n=Object.assign({ws:{match:/\s+/,lineBreaks:!0,next:"main"},comment:/\#.*/,arrow:{match:/[=-]+\>/,next:"main"},js:{match:/\{\%(?:[^%]|\%[^}])*\%\}/,value:e=>e.slice(2,-2),lineBreaks:!0},word:{match:/[\w\?\+]+/,next:"afterWord"},string:{match:/"(?:[^\\"\n]|\\["\\/bfnrt]|\\u[a-fA-F0-9]{4})*"/,value:e=>JSON.parse(e),next:"main"},btstring:{match:/`[^`]*`/,value:e=>e.slice(1,-1),next:"main",lineBreaks:!0}},function(e){var t={};for(var o of e)t[o]={match:o,next:"main"};return t}([",","|","$","%","(",")",":?",":*",":+","@include","@builtin","@","]"])),i=r.states({main:Object.assign({},n,{charclass:{match:/\.|\[(?:\\.|[^\\\n])+?\]/,value:e=>new RegExp(e)}}),afterWord:Object.assign({},n,{"[":{match:"[",next:"main"}})});var s={Lexer:i,ParserRules:[{name:"final$ebnf$1",symbols:[i.has("ws")?{type:"ws"}:ws],postprocess:t},{name:"final$ebnf$1",symbols:[],postprocess:function(e){return null}},{name:"final",symbols:["_","prog","_","final$ebnf$1"],postprocess:function(e){return e[1]}},{name:"prog",symbols:["prod"],postprocess:function(e){return[e[0]]}},{name:"prog",symbols:["prod","ws","prog"],postprocess:function(e){return[e[0]].concat(e[2])}},{name:"prod",symbols:["word","_",i.has("arrow")?{type:"arrow"}:arrow,"_","expression+"],postprocess:function(e){return{name:e[0],rules:e[4]}}},{name:"prod",symbols:["word",{literal:"["},"_","wordlist","_",{literal:"]"},"_",i.has("arrow")?{type:"arrow"}:arrow,"_","expression+"],postprocess:function(e){return{macro:e[0],args:e[3],exprs:e[9]}}},{name:"prod",symbols:[{literal:"@"},"_","js"],postprocess:function(e){return{body:e[2]}}},{name:"prod",symbols:[{literal:"@"},"word","ws","word"],postprocess:function(e){return{config:e[1],value:e[3]}}},{name:"prod",symbols:[{literal:"@include"},"_","string"],postprocess:function(e){return{include:e[2].literal,builtin:!1}}},{name:"prod",symbols:[{literal:"@builtin"},"_","string"],postprocess:function(e){return{include:e[2].literal,builtin:!0}}},{name:"expression+",symbols:["completeexpression"]},{name:"expression+",symbols:["expression+","_",{literal:"|"},"_","completeexpression"],postprocess:function(e){return e[0].concat([e[4]])}},{name:"expressionlist",symbols:["completeexpression"]},{name:"expressionlist",symbols:["expressionlist","_",{literal:","},"_","completeexpression"],postprocess:function(e){return e[0].concat([e[4]])}},{name:"wordlist",symbols:["word"]},{name:"wordlist",symbols:["wordlist","_",{literal:","},"_","word"],postprocess:function(e){return e[0].concat([e[4]])}},{name:"completeexpression",symbols:["expr"],postprocess:function(e){return{tokens:e[0]}}},{name:"completeexpression",symbols:["expr","_","js"],postprocess:function(e){return{tokens:e[0],postprocess:e[2]}}},{name:"expr_member",symbols:["word"],postprocess:t},{name:"expr_member",symbols:[{literal:"$"},"word"],postprocess:function(e){return{mixin:e[1]}}},{name:"expr_member",symbols:["word",{literal:"["},"_","expressionlist","_",{literal:"]"}],postprocess:function(e){return{macrocall:e[0],args:e[3]}}},{name:"expr_member$ebnf$1",symbols:[{literal:"i"}],postprocess:t},{name:"expr_member$ebnf$1",symbols:[],postprocess:function(e){return null}},{name:"expr_member",symbols:["string","expr_member$ebnf$1"],postprocess:function(e){return e[1]?function(e){for(var t=e.literal,o=[],r=0;r<t.length;r++){var n=t.charAt(r);n.toUpperCase()!==n||n.toLowerCase()!==n?o.push(new RegExp("["+n.toLowerCase()+n.toUpperCase()+"]")):o.push({literal:n})}return{subexpression:[{tokens:o,postprocess:function(e){return e.join("")}}]}}(e[0]):e[0]}},{name:"expr_member",symbols:[{literal:"%"},"word"],postprocess:function(e){return{token:e[1]}}},{name:"expr_member",symbols:["charclass"],postprocess:t},{name:"expr_member",symbols:[{literal:"("},"_","expression+","_",{literal:")"}],postprocess:function(e){return{subexpression:e[2]}}},{name:"expr_member",symbols:["expr_member","_","ebnf_modifier"],postprocess:function(e){return{ebnf:e[0],modifier:e[2]}}},{name:"ebnf_modifier",symbols:[{literal:":+"}],postprocess:o},{name:"ebnf_modifier",symbols:[{literal:":*"}],postprocess:o},{name:"ebnf_modifier",symbols:[{literal:":?"}],postprocess:o},{name:"expr",symbols:["expr_member"]},{name:"expr",symbols:["expr","ws","expr_member"],postprocess:function(e){return e[0].concat([e[2]])}},{name:"word",symbols:[i.has("word")?{type:"word"}:word],postprocess:o},{name:"string",symbols:[i.has("string")?{type:"string"}:string],postprocess:e=>({literal:e[0].value})},{name:"string",symbols:[i.has("btstring")?{type:"btstring"}:btstring],postprocess:e=>({literal:e[0].value})},{name:"charclass",symbols:[i.has("charclass")?{type:"charclass"}:charclass],postprocess:o},{name:"js",symbols:[i.has("js")?{type:"js"}:js],postprocess:o},{name:"_$ebnf$1",symbols:["ws"],postprocess:t},{name:"_$ebnf$1",symbols:[],postprocess:function(e){return null}},{name:"_",symbols:["_$ebnf$1"]},{name:"ws",symbols:[i.has("ws")?{type:"ws"}:ws]},{name:"ws$ebnf$1",symbols:[i.has("ws")?{type:"ws"}:ws],postprocess:t},{name:"ws$ebnf$1",symbols:[],postprocess:function(e){return null}},{name:"ws",symbols:["ws$ebnf$1",i.has("comment")?{type:"comment"}:comment,"_"]}],ParserStart:"final"};e.exports=s}()}));function compileLowLevel(e,t){var o=uniquer();t.alreadycompiled||(t.alreadycompiled=[]);for(var r={rules:[],body:[],config:{},customTokens:[],macros:{},start:""},n=0;n<e.length;n++){var i=e[n];if(u(i.name,i.pos,i.name&&i.name.length),i.body)t.nojs||r.body.push(i.body);else if(i.include){var s;if(s=i.builtin?i.include:require("path").resolve(t.file?require("path").dirname(t.file):process.cwd(),i.include),-1===t.alreadycompiled.indexOf(s)){if(t.alreadycompiled.push(s),"postprocessors.ne"===s)var a=require("nearley/builtin/postprocessors.ne");else if("whitespace.ne"===s)a=require("nearley/builtin/whitespace.ne");else if("string.ne"===s)a=require("nearley/builtin/string.ne");else if("number.ne"===s)a=require("nearley/builtin/number.ne");else if("cow.ne"===s)a=require("nearley/builtin/cow.ne");var l=nearley.Grammar.fromCompiled(nearleyLanguageBootstrapped),c=new nearley.Parser(l);c.feed(a);var p=Compile(c.results[0],{file:s,__proto__:t});r.rules=r.rules.concat(p.rules),r.body=r.body.concat(p.body),Object.keys(p.config).forEach((function(e){r.config[e]=p.config[e]})),Object.keys(p.macros).forEach((function(e){r.macros[e]=p.macros[e]}))}}else i.macro?r.macros[i.macro]={args:i.args,exprs:i.exprs}:i.config?r.config[i.config]=i.value:(g(i.name,i.rules,{}),r.start||(r.start=i.name))}return r;function u(e,o,r){t.rangeCallback&&t.rangeCallback(e,o,o+r)}function g(e,o,n){for(var i=0;i<o.length;i++){var s=d(e,o[i],n);t.nojs&&(s.postprocess=null),r.rules.push(s)}}function d(e,t,o){for(var r=[],n=0;n<t.tokens.length;n++){var i=m(e,t.tokens[n],o);null!==i&&r.push(i)}return new nearley.Rule(e,r,t.postprocess)}function m(e,t,n){if("string"==typeof t)return"null"===t?null:t;if(t instanceof RegExp)return t;if(t.literal)return t.literal.length?1===t.literal.length||r.config.lexer?t:function(e,t,r){var n=o(e+"$string");return u(n,t.pos,JSON.stringify(t.literal).length),g(n,[{tokens:t.literal.split("").map((function(e){return{literal:e}})),postprocess:{builtin:"joiner"}}],r),n}(e,t,n):null;if(t.token){if(r.config.lexer){var i=t.token;return-1===r.customTokens.indexOf(i)&&r.customTokens.push(i),{token:"("+(r.config.lexer+".has("+JSON.stringify(i)+") ? {type: "+JSON.stringify(i)+"} : "+i)+")"}}return t}if(t.subexpression)return function(e,t,r){var n=t.subexpression,i=o(e+"$subexpression");return g(i,n,r),i}(e,t,n);if(t.ebnf)return function(e,t,r){switch(t.modifier){case":+":return function(e,t,r){var n=o(e+"$ebnf");return g(n,[{tokens:[t.ebnf]},{tokens:[t.ebnf,n],postprocess:{builtin:"arrconcat"}}],r),n}(e,t,r);case":*":return function(e,t,r){var n=o(e+"$ebnf");return g(n,[{tokens:[]},{tokens:[t.ebnf,n],postprocess:{builtin:"arrconcat"}}],r),n}(e,t,r);case":?":return function(e,t,r){var n=o(e+"$ebnf");return g(n,[{tokens:[t.ebnf],postprocess:{builtin:"id"}},{tokens:[],postprocess:{builtin:"nuller"}}],r),n}(e,t,r)}}(e,t,n);if(t.macrocall)return function(e,t,n){var i=o(e+"$macrocall"),s=r.macros[t.macrocall];if(!s)throw new Error("Unkown macro: "+t.macrocall);if(s.args.length!==t.args.length)throw new Error("Argument count mismatch.");for(var a={__proto__:n},l=0;l<s.args.length;l++){var c=o(e+"$macrocall");a[s.args[l]]=c,g(c,[t.args[l]],n)}return g(i,s.exprs,a),i}(e,t,n);if(t.mixin){if(n[t.mixin])return m(e,n[t.mixin],n);throw new Error("Unbound variable: "+t.mixin)}throw new Error("unrecognized token: "+JSON.stringify(t))}}function uniquer(){var e={};return function(t){var o=e[t]=(e[t]||0)+1;return t+"$"+o}}var generate=createCommonjsModule((function(e){var t,o;t=commonjsGlobal,o=function(e){function t(e,t,i){return null==i&&(i=""),"[\n    "+e.map((function(e){return function(e,t){var i="{";return i+='"name": '+JSON.stringify(e.name),i+=', "symbols": ['+e.symbols.map(n).join(", ")+"]",e.postprocess&&(e.postprocess.builtin&&(e.postprocess=t[e.postprocess.builtin]),i+=', "postprocess": '+r(o(e.postprocess),"        ",{indentFirst:!1})),i+="}"}(e,t)})).join(",\n    ")+"\n"+i+"]"}function o(e){var t=e.toString().split(/\n/);if(1===t.length)return[t[0].replace(/^\s+|\s+$/g,"")];for(var o=null,r=t.slice(1),n=0;n<r.length;n++){var i=/^\s*/.exec(r[n]);i&&i[0].length!==r[n].length&&(null===o||i[0].length<o.length)&&(o=i[0])}return null===o?t:t.map((function(e){return e.slice(0,o.length)===o?e.slice(o.length):e}))}function r(e,t,o){var r;return r=Array.isArray(e)?e:e.toString().split("\n"),o=o||{},r.map((function(e,r){var n=!0;return 0!=r||o.indentFirst||(n=!1),n?t+e:e})).join("\n")}function n(e){return e instanceof RegExp?e.toString():e.token?e.token:JSON.stringify(e)}var i=function(e,t){if(e.config.preprocessor||(e.config.preprocessor="_default"),!i[e.config.preprocessor])throw new Error("No such preprocessor: "+e.config.preprocessor);return i[e.config.preprocessor](e,t)};return i.js=i._default=i.javascript=function(e,o){var r="// Generated automatically by nearley, version "+e.version+"\n";return r+="// http://github.com/Hardmath123/nearley\n",r+="(function () {\n",r+="function id(x) { return x[0]; }\n",r+=e.body.join("\n"),r+="var grammar = {\n",r+="    Lexer: "+e.config.lexer+",\n",r+="    ParserRules: "+t(e.rules,i.javascript.builtinPostprocessors)+"\n",r+="  , ParserStart: "+JSON.stringify(e.start)+"\n",r+="}\n",r+="if (typeof module !== 'undefined'&& typeof module.exports !== 'undefined') {\n",r+="   module.exports = grammar;\n",r+="} else {\n",r+="   window."+o+" = grammar;\n",r+="}\n",r+="})();\n"},i.javascript.builtinPostprocessors={joiner:"function joiner(d) {return d.join('');}",arrconcat:"function arrconcat(d) {return [d[0]].concat(d[1]);}",arrpush:"function arrpush(d) {return d[0].concat([d[1]]);}",nuller:"function(d) {return null;}",id:"id"},i.module=i.esmodule=function(e,o){var r="// Generated automatically by nearley, version "+e.version+"\n";return r+="// http://github.com/Hardmath123/nearley\n",r+="function id(x) { return x[0]; }\n",r+=e.body.join("\n"),r+="let Lexer = "+e.config.lexer+";\n",r+="let ParserRules = "+t(e.rules,i.javascript.builtinPostprocessors)+";\n",r+="let ParserStart = "+JSON.stringify(e.start)+";\n",r+="export default { Lexer, ParserRules, ParserStart };\n"},i.cs=i.coffee=i.coffeescript=function(e,n){var s="# Generated automatically by nearley, version "+e.version+"\n";return s+="# http://github.com/Hardmath123/nearley\n",s+="do ->\n",s+="  id = (d) -> d[0]\n",s+=r(o(e.body.join("\n")),"  ")+"\n",s+="  grammar = {\n",s+="    Lexer: "+e.config.lexer+",\n",s+="    ParserRules: "+r(t(e.rules,i.coffeescript.builtinPostprocessors),"      ",{indentFirst:!1})+",\n",s+="    ParserStart: "+JSON.stringify(e.start)+"\n",s+="  }\n",s+="  if typeof module != 'undefined' && typeof module.exports != 'undefined'\n",s+="    module.exports = grammar;\n",s+="  else\n",s+="    window."+n+" = grammar;\n"},i.coffeescript.builtinPostprocessors={joiner:"(d) -> d.join('')",arrconcat:"(d) -> [d[0]].concat(d[1])",arrpush:"(d) -> d[0].concat([d[1]])",nuller:"() -> null",id:"id"},i.ts=i.typescript=function(e,o){var r="// Generated automatically by nearley, version "+e.version+"\n";return r+="// http://github.com/Hardmath123/nearley\n",r+="// Bypasses TS6133. Allow declared but unused functions.\n",r+="// @ts-ignore\n",r+="function id(d: any[]): any { return d[0]; }\n",r+=e.customTokens.map((function(e){return"declare var "+e+": any;\n"})).join(""),r+=e.body.join("\n"),r+="\n",r+="interface NearleyToken {\n",r+="  value: any;\n",r+="  [key: string]: any;\n",r+="};\n",r+="\n",r+="interface NearleyLexer {\n",r+="  reset: (chunk: string, info: any) => void;\n",r+="  next: () => NearleyToken | undefined;\n",r+="  save: () => any;\n",r+="  formatError: (token: never) => string;\n",r+="  has: (tokenType: string) => boolean;\n",r+="};\n",r+="\n",r+="interface NearleyRule {\n",r+="  name: string;\n",r+="  symbols: NearleySymbol[];\n",r+="  postprocess?: (d: any[], loc?: number, reject?: {}) => any;\n",r+="};\n",r+="\n",r+="type NearleySymbol = string | { literal: any } | { test: (token: any) => boolean };\n",r+="\n",r+="interface Grammar {\n",r+="  Lexer: NearleyLexer | undefined;\n",r+="  ParserRules: NearleyRule[];\n",r+="  ParserStart: string;\n",r+="};\n",r+="\n",r+="const grammar: Grammar = {\n",r+="  Lexer: "+e.config.lexer+",\n",r+="  ParserRules: "+t(e.rules,i.typescript.builtinPostprocessors,"  ")+",\n",r+="  ParserStart: "+JSON.stringify(e.start)+",\n",r+="};\n",r+="\n",r+="export default grammar;\n"},i.typescript.builtinPostprocessors={joiner:"(d) => d.join('')",arrconcat:"(d) => [d[0]].concat(d[1])",arrpush:"(d) => d[0].concat([d[1]])",nuller:"() => null",id:"id"},i},e.exports?e.exports=o():t.generate=o(t.nearley)})),warn=function(e,t){e.out.write("WARN\t"+t+"\n")};function lintNames(e,t){var o=[];e.rules.forEach((function(e){o.push(e.name)})),e.rules.forEach((function(e){e.symbols.forEach((function(e){e.literal||e.token||e.constructor===RegExp||-1===o.indexOf(e)&&warn(t,"Undefined symbol `"+e+"` used.")}))}))}function lint(e,t){t.out||(t.out=process.stderr),lintNames(e,t)}var lint_1=lint,objectID=0,vars={},jsFuncMap={saw:{setup:(e,t)=>`${e} = new Maximilian.maxiOsc();\n                      ${e}.phaseReset(${t.length>1?t[1].loop:0});`,loop:(e,t)=>`${e}.saw(${t[0].loop})`},sin:{setup:(e,t)=>`${e} = new Maximilian.maxiOsc();\n                      ${e}.phaseReset(${t.length>1?t[1].loop:0});`,loop:(e,t)=>`${e}.sinewave(${t[0].loop})`},tri:{setup:(e,t)=>`${e} = new Maximilian.maxiOsc();\n                      ${e}.phaseReset(${t.length>1?t[1].loop:0});`,loop:(e,t)=>`${e}.triangle(${t[0].loop})`},pha:{setup:(e,t)=>`${e} = new Maximilian.maxiOsc();\n                      ${e}.phaseReset(${t.length>1?t[1].loop:0});`,loop:(e,t)=>`${e}.phasor(${t[0].loop})`},ph2:{setup:(e,t)=>`${e} = new Maximilian.maxiOsc();\n                      ${e}.phaseReset(${t.length>3?t[3].loop:0});`,loop:(e,t)=>`${e}.phasorBetween(${t[0].loop},${t[1].loop},${t[2].loop})`},sqr:{setup:(e,t)=>`${e} = new Maximilian.maxiOsc();\n                      ${e}.phaseReset(${t.length>1?t[1].loop:0});`,loop:(e,t)=>`${e}.square(${t[0].loop})`},pul:{setup:(e,t)=>`${e} = new Maximilian.maxiOsc();\n                      ${e}.phaseReset(${t.length>2?t[2].loop:0});`,loop:(e,t)=>`${e}.pulse(${t[0].loop},${t[1].loop})`},imp:{setup:(e,t)=>`${e} = new Maximilian.maxiOsc();\n                      ${e}.phaseReset(${t.length>1?t[1].loop:0});`,loop:(e,t)=>`${e}.impulse(${t[0].loop})`},sawn:{setup:(e,t)=>`${e} = new Maximilian.maxiOsc();\n                      ${e}.phaseReset(${t.length>1?t[1].loop:0});`,loop:(e,t)=>`${e}.sawn(${t[0].loop})`},noiz:{setup:(e,t)=>`${e} = new Maximilian.maxiOsc()`,loop:(e,t)=>`${e}.noise()*${t[0].loop}`},gt:{setup:(e,t)=>"",loop:(e,t)=>`((${t[0].loop} > ${t[1].loop}) ? 1 : 0)`},lt:{setup:(e,t)=>"",loop:(e,t)=>`((${t[0].loop} < ${t[1].loop}) ? 1 : 0)`},mod:{setup:(e,t)=>"",loop:(e,t)=>`(${t[0].loop} % ${t[1].loop})`},add:{setup:(e,t)=>"",loop:(e,t)=>`(${t[0].loop} + ${t[1].loop})`},mul:{setup:(e,t)=>"",loop:(e,t)=>`(${t[0].loop} * ${t[1].loop})`},sub:{setup:(e,t)=>"",loop:(e,t)=>`(${t[0].loop} - ${t[1].loop})`},div:{setup:(e,t)=>"",loop:(e,t)=>`(${t[1].loop} != 0 ? ${t[0].loop}/${t[1].loop} : 0)`},pow:{setup:(e,t)=>"",loop:(e,t)=>`Math.pow(${t[0].loop},${t[1].loop})`},abs:{setup:(e,t)=>"",loop:(e,t)=>`Math.abs(${t[0].loop})`},env:{setup:(e,t)=>`${e} = new Maximilian.maxiEnv();\n                      ${e}.setAttack(${t[1].loop});\n                      ${e}.setDecay(${t[2].loop});\n                      ${e}.setSustain(${t[3].loop});\n                      ${e}.setRelease(${t[4].loop})`,loop:(e,t)=>`${e}.adsr(1,${t[0].loop})`},sum:{setup:(e,t)=>"",loop:(e,t)=>{let o=`(${t[0].loop}`;for(let e=1;e<t.length;e++)o+=`+${t[e].loop}`;return o+")"}},mix:{setup:(e,t)=>"",loop:(e,t)=>{let o=`((${t[0].loop}`;for(let e=1;e<t.length;e++)o+=`+${t[e].loop}`;return o+`)/${t.length})`}},prod:{setup:(e,t)=>"",loop:(e,t)=>{let o=`(${t[0].loop}`;for(let e=1;e<t.length;e++)o+=`*${t[e].loop}`;return o+")"}},blin:{setup:(e,t)=>"",loop:(e,t)=>`Maximilian.maxiMap.linlin(${t[0].loop}, -1, 1, ${t[1].loop}, ${t[2].loop})`},ulin:{setup:(e,t)=>"",loop:(e,t)=>`Maximilian.maxiMap.linlin(${t[0].loop}, 0, 1, ${t[1].loop}, ${t[2].loop})`},bexp:{setup:(e,t)=>"",loop:(e,t)=>`Maximilian.maxiMap.linexp(${t[0].loop}, -1, 1, ${t[1].loop}, ${t[2].loop})`},uexp:{setup:(e,t)=>"",loop:(e,t)=>`Maximilian.maxiMap.linexp(${t[0].loop}, 0.0000001, 1, ${t[1].loop}, ${t[2].loop})`},linlin:{setup:(e,t)=>"",loop:(e,t)=>`Maximilian.maxiMap.linlin(${t[0].loop}, ${t[1].loop}, ${t[2].loop},${t[3].loop}, ${t[4].loop})`},linexp:{setup:(e,t)=>"",loop:(e,t)=>`Maximilian.maxiMap.linexp(${t[0].loop}, ${t[1].loop}, ${t[2].loop}, ${t[3].loop}, ${t[4].loop})`},dist:{setup:(e,t)=>`${e} = new Maximilian.maxiNonlinearity()`,loop:(e,t)=>`${e}.atanDist(${t[0].loop},${t[1].loop})`},softclip:{setup:(e,t)=>`${e} = new Maximilian.maxiNonlinearity()`,loop:(e,t)=>`${e}.softclip(${t[0].loop})`},hardclip:{setup:(e,t)=>`${e} = new Maximilian.maxiNonlinearity()`,loop:(e,t)=>`${e}.hardclip(${t[0].loop})`},asymclip:{setup:(e,t)=>`${e} = new Maximilian.maxiNonlinearity()`,loop:(e,t)=>`${e}.asymclip(${t[0].loop},${t[1].loop},${t[2].loop})`},flange:{setup:(e,t)=>`${e} = new Maximilian.maxiFlanger()`,loop:(e,t)=>`${e}.flange(${t[0].loop},${t[1].loop},${t[2].loop},${t[3].loop},${t[4].loop})`},chor:{setup:(e,t)=>`${e} = new Maximilian.maxiChorus()`,loop:(e,t)=>`${e}.chorus(${t[0].loop},${t[1].loop},${t[2].loop},${t[3].loop},${t[4].loop})`},dl:{setup:(e,t)=>`${e} = new Maximilian.maxiDelayline()`,loop:(e,t)=>`${e}.dl(${t[0].loop},${t[1].loop},${t[2].loop})`},lpf:{setup:(e,t)=>`${e} = new Maximilian.maxiFilter()`,loop:(e,t)=>`${e}.lopass(${t[0].loop},${t[1].loop})`},hpf:{setup:(e,t)=>`${e} = new Maximilian.maxiFilter()`,loop:(e,t)=>`${e}.hipass(${t[0].loop},${t[1].loop})`},lpz:{setup:(e,t)=>`${e} = new Maximilian.maxiFilter()`,loop:(e,t)=>`${e}.lores(${t[0].loop},${t[1].loop},${t[2].loop})`},hpz:{setup:(e,t)=>`${e} = new Maximilian.maxiFilter()`,loop:(e,t)=>`${e}.hires(${t[0].loop},${t[1].loop},${t[2].loop})`},toJS:{setup:(e,t)=>`${e} = new SABOutputTransducer(outputSABs,\n                                      this.port,\n                                      'ML',\n                                      ${t[1].loop},\n                                      this.currentSample,\n                                      ${3==t.length?1:t[3].loop})`,loop:(e,t)=>`${e}.send(${t[0].loop}, ${t[2].loop})`},fromJS:{setup:(e,t)=>`${e} = new SABInputTransducer(${t[0].loop}, ${2==t.length?1:0})`,loop:(e,t)=>`${e}.getSABValue(inputSABs, ${2==t.length?t[1].loop:0})`},mouseX:{setup:(e,t)=>"",loop:(e,t)=>"this.getSABValue('mxy')[0]"},mouseY:{setup:(e,t)=>"",loop:(e,t)=>"this.getSABValue('mxy')[1]"},at:{setup:(e,t)=>"",loop:(e,t)=>`${t[0].loop}[Math.min(${t[1].loop}, ${t[0].loop}.length-1)]`},sah:{setup:(e,t)=>`${e} = new Maximilian.maxiSampleAndHold();`,loop:(e,t)=>`${e}.sah(${t[0].loop},${t[1].loop})`},stretch:{setup:(e,t)=>`${e} = new Maximilian.maxiSample();\n                      ${e}.setSample(this.getSampleBuffer(${t[4].loop}));\n                      ${e}stretch = new Maximilian.maxiStretch();\n                      ${e}stretch.setSample(${e});`,loop:(e,t)=>`(${e}.isReady() ? ${e}stretch.play(${t[0].loop},${t[1].loop},${t[2].loop},${t[3].loop},0.0) : 0.0)`},adc:{setup:(e,t)=>"",loop:(e,t)=>`(inputs * ${t[0].loop})`},sampler:{setup:(e,t)=>`${e} = new Maximilian.maxiSample();\n                      ${e}.setSample(this.getSampleBuffer(${t[t.length-1].loop}));`,loop:(e,t)=>{let o=`${t[0].loop}`;return 3==t.length?o+=`,${t[1].loop}`:4==t.length&&(o+=`,${t[1].loop},${t[2].loop}`),`(${e}.isReady() ? ${e}.playOnZX(${o}) : 0.0)`}},loop:{setup:(e,t)=>`${e} = new Maximilian.maxiSample();\n                      ${e}.setSample(this.getSampleBuffer(${t[1].loop}));`,loop:(e,t)=>`(${e}.isReady() ? ${e}.play(${t[0].loop}) : 0.0)`},slice:{setup:(e,t)=>`${e} = new Maximilian.maxiSample();\n                      ${e}.setSample(this.getSampleBuffer(${t[2].loop}));`,loop:(e,t)=>`(${e}.isReady() ? ${e}.loopSetPosOnZX(${t[0].loop},${t[1].loop}) : 0.0)`},oscin:{setup:(e,t)=>"",loop:(e,t)=>`this.OSCTransducer(${t[0].loop},${t[1].loop})`},oscout:{setup:(e,t)=>"",loop:(e,t)=>`this.OSCTransducer(${t[0].loop},${t[1].loop})`},sah:{setup:(e,t)=>`${e} = new Maximilian.maxiSampleAndHold();`,loop:(e,t)=>`${e}.sah(${t[0].loop},${t[1].loop})`},stretch:{setup:(e,t)=>`${e} = new Maximilian.maxiSample();\n                      ${e}.setSample(this.getSampleBuffer(${t[4].loop}));\n                      ${e}stretch = new Maximilian.maxiStretch();\n                      ${e}stretch.setSample(${e});`,loop:(e,t)=>`(${e}.isReady() ? ${e}stretch.play(${t[0].loop},${t[1].loop},${t[2].loop},${t[3].loop},0.0) : 0.0)`},bitToSig:{setup:(e,t)=>"",loop:(e,t)=>`Maximilian.maxiBits.toSignal(${t[0].loop})`},bitToTrigSig:{setup:(e,t)=>"",loop:(e,t)=>`Maximilian.maxiBits.toTrigSignal(${t[0].loop})`},bitNeg:{setup:(e,t)=>"",loop:(e,t)=>`Maximilian.maxiBits.neg(${t[0].loop})`},bitInc:{setup:(e,t)=>"",loop:(e,t)=>`Maximilian.maxiBits.inc(${t[0].loop})`},bitDec:{setup:(e,t)=>"",loop:(e,t)=>`Maximilian.maxiBits.dec(${t[0].loop})`},bitAnd:{setup:(e,t)=>"",loop:(e,t)=>`Maximilian.maxiBits.land(${t[0].loop},${t[1].loop})`},bitOr:{setup:(e,t)=>"",loop:(e,t)=>`Maximilian.maxiBits.lor(${t[0].loop},${t[1].loop})`},bitXor:{setup:(e,t)=>"",loop:(e,t)=>`Maximilian.maxiBits.lxor(${t[0].loop},${t[1].loop})`},bitShl:{setup:(e,t)=>"",loop:(e,t)=>`Maximilian.maxiBits.shl(${t[0].loop},${t[1].loop})`},bitShr:{setup:(e,t)=>"",loop:(e,t)=>`Maximilian.maxiBits.shr(${t[0].loop},${t[1].loop})`},bitAt:{setup:(e,t)=>"",loop:(e,t)=>`Maximilian.maxiBits.at(${t[0].loop},${t[1].loop})`},bitAdd:{setup:(e,t)=>"",loop:(e,t)=>`Maximilian.maxiBits.add(${t[0].loop},${t[1].loop})`},bitSub:{setup:(e,t)=>"",loop:(e,t)=>`Maximilian.maxiBits.sub(${t[0].loop},${t[1].loop})`},bitMul:{setup:(e,t)=>"",loop:(e,t)=>`Maximilian.maxiBits.mul(${t[0].loop},${t[1].loop})`},bitEq:{setup:(e,t)=>"",loop:(e,t)=>`Maximilian.maxiBits.eq(${t[0].loop},${t[1].loop})`},bitGt:{setup:(e,t)=>"",loop:(e,t)=>`Maximilian.maxiBits.gt(${t[0].loop},${t[1].loop})`},bitGte:{setup:(e,t)=>"",loop:(e,t)=>`Maximilian.maxiBits.gte(${t[0].loop},${t[1].loop})`},bitLte:{setup:(e,t)=>"",loop:(e,t)=>`Maximilian.maxiBits.lte(${t[0].loop},${t[1].loop})`},bitLt:{setup:(e,t)=>"",loop:(e,t)=>`Maximilian.maxiBits.lt(${t[0].loop},${t[1].loop})`},setup:(e,t)=>"",bitDiv:{loop:(e,t)=>`Maximilian.maxiBits.div(${t[0].loop},${t[1].loop})`},bitr:{setup:(e,t)=>"",loop:(e,t)=>`Maximilian.maxiBits.at(${t[0].loop},${t[1].loop},${t[2].loop})`},bitnoise:{setup:(e,t)=>"",loop:(e,t)=>"Maximilian.maxiBits.noise()"},btime:{setup:(e,t)=>"",loop:(e,t)=>"this.bitTime"},bitFromSig:{setup:(e,t)=>"",loop:(e,t)=>`Maximilian.maxiBits.fromSignal(${t[0].loop})`},clp:{setup:(e,t)=>"",loop:(e,t)=>`this.clockPhase(${t[0].loop},${t.length>1?t[1].loop:0})`},clt:{setup:(e,t)=>"",loop:(e,t)=>`this.clockTrig(${t[0].loop},${t.length>1?t[1].loop:0})`},clk:{setup:(e,t)=>"",loop:(e,t)=>`(()=>{this.setBPM(${t[0].loop}); this.setBeatsPerBar(${t[1].loop});})()`},onzx:{setup:(e,t)=>`${e} = new Maximilian.maxiTrigger();`,loop:(e,t)=>`${e}.onZX(${t[0].loop})`},onchange:{setup:(e,t)=>`${e} = new Maximilian.maxiTrigger();`,loop:(e,t)=>`${e}.onChanged(${t[0].loop},${t[1].loop})`},count:{setup:(e,t)=>`${e} = new Maximilian.maxiCounter();`,loop:(e,t)=>`${e}.count(${t[0].loop},${t[1].loop})`},idx:{setup:(e,t)=>`${e} = new Maximilian.maxiIndex();`,loop:(e,t)=>`${e}.pull(${t[0].loop},${t[1].loop},${t[2].loop})`},svf:{setup:(e,t)=>`${e} = new Maximilian.maxiSVF();\n                      ${e}_p1 = new Maximilian.maxiTrigger();\n                      ${e}_p2 = new Maximilian.maxiTrigger();`,loop:(e,t)=>`( () => { ${e}_cutoff = ${t[1].loop};\n                                if (${e}_p1.onChanged(${e}_cutoff, 1e-5)) {${e}.setCutoff(${e}_cutoff)};\n                                ${e}_res = ${t[2].loop};\n                                if (${e}_p2.onChanged(${e}_res, 1e-5)) {${e}.setResonance(${e}_res)};\n                                return ${e}.play(${t[0].loop},${t[3].loop},${t[4].loop},${t[5].loop},${t[6].loop})})()`},bitclock:{setup:(e,t)=>"",loop:(e,t)=>"this.bitclock"},pvshift:{setup:(e,t)=>`${e} = new pvshift();`,loop:(e,t)=>`${e}.play(${t[0].loop},${t[1].loop})`},rsq:{setup:(e,t)=>`${e} = new Maximilian.maxiRatioSeq();`,loop:(e,t)=>2==t.length?`${e}.playTrig(${t[0].loop},${t[1].loop})`:`${e}.playValues(${t[0].loop},${t[1].loop},${t[2].loop})`},o303:{setup:(e,t)=>`${e} = new Open303.Open303();\n                      ${e}.setSampleRate(sampleRate);\n                      ${e}_tnote = new Maximilian.maxiTrigger();\n                      ${e}_twf = new Maximilian.maxiTrigger();\n                      ${e}_tcut = new Maximilian.maxiTrigger();\n                      ${e}_tres = new Maximilian.maxiTrigger();\n                      ${e}_tenvm = new Maximilian.maxiTrigger();\n                      ${e}_tdec = new Maximilian.maxiTrigger();\n                      ${e}_tnoteoff = new Maximilian.maxiTrigger();\n                      ${e}_tatt = new Maximilian.maxiTrigger();`,loop:(e,t)=>`(()=>{\n\t\t\tlet newNote = ${e}_tnote.onZX(${t[0].loop});\n\t\t\tlet accent = ${t[3].loop};\n\t\t\tif (newNote) {\n\t\t\t\tif (${t[2].loop}>0) {\n\t\t\t\t\t${e}.slideToNote(${t[1].loop},accent);\n\t\t\t\t}else{\n\t\t\t\t\t${e}.triggerNote(${t[1].loop},accent);\n\t\t\t\t}\n\t\t\t};\n\n\t\t\tif (${e}_tnoteoff.onChanged(${t[4].loop}, 1e-5)) {${e}.allNotesOff()};\n\t\t\tif (${e}_twf.onChanged(${t[5].loop}, 1e-5)) {${e}.setWaveform(${t[5].loop})};\n\t\t\tif (${e}_tcut.onChanged(${t[6].loop}, 1e-5)) {${e}.setCutoff(${t[6].loop})};\n\t\t\tif (${e}_tres.onChanged(${t[7].loop}, 1e-5)) {${e}.setResonance(${t[7].loop})};\n\t\t\tif (${e}_tenvm.onChanged(${t[8].loop}, 1e-5)) {${e}.setEnvMod(${t[8].loop})};\n\t\t\tif (${e}_tatt.onChanged(${t[9].loop}, 1e-5)) {${e}.setNormalAttack(${t[9].loop})};\n\t\t\tif (${e}_tdec.onChanged(${t[10].loop}, 1e-5)) {${e}.setDecay(${t[10].loop})};\n\t\t\t${e}.setAccent(${t[11].loop});\n\t\t\treturn ${e}.play();})()`},freeverb:{setup:(e,t)=>`${e} = new Maximilian.maxiFreeVerb();`,loop:(e,t)=>`${e}.play(${t[0].loop},${t[1].loop},${t[2].loop})`},line:{setup:(e,t)=>`${e} = new Maximilian.maxiLine(); ${e}.prepare(0,1,${t[1].loop}, false); ${e}.triggerEnable(1);`,loop:(e,t)=>`${e}.play(${t[0].loop})`},const:{setup:(e,t)=>"",loop:(e,t)=>`${t[0].loop}`},poll:{setup:(e,t)=>`${e} = new poll()`,loop:(e,t)=>`${e}.play(${t[0].loop})`},dac:{setup:(e,t)=>"",loop:(e,t)=>1==t.length?`this.dacOutAll(${t[0].loop})`:`this.dacOut(${t[0].loop},${t[1].loop})`},fft:{setup:(e,t)=>`${e} = new fft(${t[1].loop}, ${t[2].loop})`,loop:(e,t)=>`${e}.play(${t[0].loop})`},ifft:{setup:(e,t)=>`${e} = new ifft(${t[3].loop}, ${t[4].loop})`,loop:(e,t)=>`${e}.play(${t[0].loop}, ${t[1].loop}, ${t[2].loop})`},mfcc:{setup:(e,t)=>`${e} = new mfcc(${t[1].loop}, ${t[2].loop}, ${t[3].loop})`,loop:(e,t)=>`${e}.play(${t[0].loop})`}};class ASTreeToJavascript{static getNextID(){return objectID=objectID>9999?0:++objectID}static emptyCode(){return{setup:"",loop:"",paramMarkers:[]}}static traverseTree(e,t,o,r,n){let i={"@lang":(e,t)=>(t.map((t=>{let i=ASTreeToJavascript.traverseTree(t,ASTreeToJavascript.emptyCode(),o,r,n);e.setup+=i.setup,e.loop+=i.loop})),e),"@spawn":(e,t)=>((e=ASTreeToJavascript.traverseTree(t,e,o,r,n)).loop+=";",e),"@sigp":(e,t)=>{let i=[{s:t.paramBegin,e:t.paramEnd,l:o}];e.paramMarkers=e.paramMarkers.concat(i);let s=t["@func"].value,a=jsFuncMap[s],l="q.b"+n+"u"+ASTreeToJavascript.getNextID(),c=[];for(let e=0;e<t["@params"].length;e++){let i=ASTreeToJavascript.emptyCode();i=ASTreeToJavascript.traverseTree(t["@params"][e],i,o+1,r,n),c[e]=i}let p="";for(let t in c)p+=c[t].setup,e.paramMarkers=e.paramMarkers.concat(c[t].paramMarkers);return e.setup+=`${p} ${a.setup(l,c)};`,e.loop+=`${a.loop(l,c)}`,e},"@setvar":(e,t)=>{let i=t["@varname"],s=r[i];null==s&&(s=Object.keys(r).length,r[i]=s);let a=ASTreeToJavascript.traverseTree(t["@varvalue"],ASTreeToJavascript.emptyCode(),o+1,r,n);return e.setup+=a.setup,e.loop=`(mem[${s}] = ${a.loop})`,e},"@getvar":(e,t)=>{let o=r[t];return null==o&&(o=Object.keys(r).length,r[t]=o),e.loop+=`(mem[${o}] != undefined ? mem[${o}] : 0)`,e},"@string":(e,t)=>(("string"==typeof t||t instanceof String)&&(e.loop+=`'${t}'`),e),"@num":(e,t)=>(null!=t.value&&(e.loop+=`${t.value}`),e),"@list":(e,t)=>{let i="q.b"+n+"l"+ASTreeToJavascript.getNextID();e.setup+=`${i} = new Float64Array(${t.length});`,e.loop+="(()=>{";let s="";for(let a=0;a<t.length;a++){let l=ASTreeToJavascript.traverseTree(t[a],ASTreeToJavascript.emptyCode(),o,r,n);"@num"==Object.keys(t[a])[0]?e.setup+=`${i}[${a}] = ${l.loop};`:(s+=l.setup,e.loop+=`${i}[${a}] = ${l.loop};`)}return e.loop+=`return ${i}})()`,e.setup+=s,e}};return Array.isArray(e)?e.map((e=>{Object.keys(e).map((o=>{t=i[o](t,e[o])}))})):Object.keys(e).map((o=>{t=i[o](t,e[o])})),t}static treeToCode(e,t=0){vars={};let o=ASTreeToJavascript.traverseTree(e,ASTreeToJavascript.emptyCode(),0,vars,t);return o.setup=`() => {let q=this.newq(); ${o.setup}; return q;}`,o.loop=`(q, inputs, mem) => {${o.loop}}`,o}}var IR=Object.freeze({__proto__:null,default:ASTreeToJavascript}),sema=createCommonjsModule((function(e){var t;t=commonjsGlobal,e.exports?e.exports={num:function(e){return{"@num":{value:e}}},str:function(e){return{"@string":e}},synth:function(e,t){return{"@sigp":{"@params":t,"@func":{value:e}}}},setvar:function(e,t){return{"@setvar":{"@varname":e,"@varvalue":t}}},getvar:function(e){return{"@getvar":e}}}:t.sema={num:function(e){return{"@num":{value:e}}},str:function(e){return{"@string":e}},synth:function(e,t){return{"@sigp":{"@params":t,"@func":{value:e}}}},setvar:function(e,t){return{"@setvar":{"@varname":e,"@varvalue":t}}},getvar:function(e){return{"@getvar":e}}}}));function getParserModuleExports(source){let sema$1=sema;sema$1.num("3");let module={exports:""};return eval(source),module.exports}function compile(e,t){let o;const{errors:r,output:n}=compileGrammar(e),i=getParserModuleExports(n),s=new nearley.Parser(i);if(!r&&s){const e=s.feed(t);e&&(o=ASTreeToJavascript.treeToCode(e.results,0))}return{errors:r,dspCode:o}}function stream(){let e="";return{write(t){e+=t},dump:()=>e}}function AnnotatePositions(e){return e.map((e=>new nearley.Rule(e.name,e.symbols,e.postprocess&&((t,o,r)=>{var n=e.postprocess(t,o,r);return null===n?null:("object"!=typeof n||n.slice||(n.pos=o),n)}))))}function compileGrammar(e){let t=new nearley.Parser(AnnotatePositions(nearleyLanguageBootstrapped.ParserRules),nearleyLanguageBootstrapped.ParserStart,{lexer:nearleyLanguageBootstrapped.Lexer}),o=stream(),r="",n={};try{if(t.feed(e),t.results[0]){var i=compileLowLevel(t.results[0],{rangeCallback:function(e,t,o){n[e]=[t,o]}});lint_1(i,{out:o}),r=generate(i,"grammar")}}catch(e){o.write(e)}return{errors:o.dump(),positions:n,output:r}}var WorkerClass=null;try{var WorkerThreads="undefined"!=typeof module&&"function"==typeof module.require&&module.require("worker_threads")||"function"==typeof __non_webpack_require__&&__non_webpack_require__("worker_threads")||"function"==typeof require&&require("worker_threads");WorkerClass=WorkerThreads.Worker}catch(e){}function decodeBase64(e,t){return Buffer.from(e,"base64").toString(t?"utf16":"utf8")}function createBase64WorkerFactory(e,t,o){var r=void 0===t?null:t,n=decodeBase64(e,void 0!==o&&o),i=n.indexOf("\n",10)+1,s=n.substring(i)+(r?"//# sourceMappingURL="+r:"");return function(e){return new WorkerClass(s,Object.assign({},e,{eval:!0}))}}function decodeBase64$1(e,t){var o=atob(e);if(t){for(var r=new Uint8Array(o.length),n=0,i=o.length;n<i;++n)r[n]=o.charCodeAt(n);return String.fromCharCode.apply(null,new Uint16Array(r.buffer))}return o}function createURL(e,t,o){var r=void 0===t?null:t,n=decodeBase64$1(e,void 0!==o&&o),i=n.indexOf("\n",10)+1,s=n.substring(i)+(r?"//# sourceMappingURL="+r:""),a=new Blob([s],{type:"application/javascript"});return URL.createObjectURL(a)}function createBase64WorkerFactory$1(e,t,o){var r;return function(n){return r=r||createURL(e,t,o),new Worker(r,n)}}var kIsNodeJS="[object process]"===Object.prototype.toString.call("undefined"!=typeof process?process:0);function isNodeJS(){return kIsNodeJS}function createBase64WorkerFactory$2(e,t,o){return isNodeJS()?createBase64WorkerFactory(e,t,o):createBase64WorkerFactory$1(e,t,o)}var WorkerFactory=createBase64WorkerFactory$2("Lyogcm9sbHVwLXBsdWdpbi13ZWItd29ya2VyLWxvYWRlciAqLwohZnVuY3Rpb24oKXsidXNlIHN0cmljdCI7ZnVuY3Rpb24gbihuKXtpZihuZXcgVVJMKG4pKXRyeXtpbXBvcnRTY3JpcHRzKG4rIi9sYWxvbGliLmpzIiksaW1wb3J0U2NyaXB0cyhuKyIvc3ZkLmpzIiksaW1wb3J0U2NyaXB0cyhuKyIvbWx3b3JrZXJzY3JpcHRzLmpzIiksaW1wb3J0U2NyaXB0cygiaHR0cHM6Ly9jZG4uanNkZWxpdnIubmV0L25wbS9AdGVuc29yZmxvdy90ZmpzL2Rpc3QvdGYubWluLmpzIiksZnVuY3Rpb24oKXtpZighbil7dmFyIG49ZXZhbDtuKCJ2YXIgaW5wdXQgPSAodmFsdWUsIGNoYW5uZWwpID0+IHt9IiksbigidmFyIG91dHB1dCA9ICh2YWx1ZSxjaGFubmVsKSA9PiB7cG9zdE1lc3NhZ2Uoe2Z1bmM6J2RhdGEnLCB2YWw6dmFsdWUsIGNoOmNoYW5uZWx9KTt9IiksbigiXG52YXIgb3V0cHV0U0FCcyA9IHt9O1xuY2xhc3MgTUxTQUJPdXRwdXRUcmFuc2R1Y2VyIHtcbiAgY29uc3RydWN0b3IoYnVmZmVyVHlwZSwgY2hhbm5lbCwgYmxvY2tzaXplKSB7XG4gICAgdGhpcy5jaGFubmVsID0gY2hhbm5lbDtcbiAgICB0aGlzLmJsb2Nrc2l6ZSA9IGJsb2Nrc2l6ZTtcblxuICAgIC8vY2hlY2sgZm9yIGV4aXN0aW5nIGNoYW5uZWxzXG4gICAgaWYgKGNoYW5uZWwgaW4gb3V0cHV0U0FCcyAmJiBvdXRwdXRTQUJzW2NoYW5uZWxdLmJsb2Nrc2l6ZSA9PSBibG9ja3NpemUpIHtcbiAgICAgIC8vcmV1c2UgZXhpc3RpbmdcbiAgICAgIHRoaXMucmluZ2J1ZiA9IG91dHB1dFNBQnNbY2hhbm5lbF0ucmI7XG4gICAgfWVsc2V7XG4gICAgICAvL2NyZWF0ZSBhIG5ldyBTQUIgYW5kIG5vdGlmeSB0aGUgcmVjZWl2ZXJcbiAgICAgIHRoaXMuc2FiID0gUmluZ0J1ZmZlci5nZXRTdG9yYWdlRm9yQ2FwYWNpdHkoMzIgKiBibG9ja3NpemUsIEZsb2F0NjRBcnJheSk7XG4gICAgICB0aGlzLnJpbmdidWYgPSBuZXcgUmluZ0J1ZmZlcih0aGlzLnNhYiwgRmxvYXQ2NEFycmF5KTtcbiAgICAgIG91dHB1dFNBQnNbY2hhbm5lbF0gPSB7cmI6dGhpcy5yaW5nYnVmLCBzYWI6dGhpcy5zYWIsIGNyZWF0ZWQ6RGF0ZS5ub3coKSwgYmxvY2tzaXplOmJsb2Nrc2l6ZX07XG5cbiAgICAgIHBvc3RNZXNzYWdlKHtcbiAgICAgICAgZnVuYzogJ3NhYicsXG4gICAgICAgIHZhbHVlOiB0aGlzLnNhYixcbiAgICAgICAgdHR5cGU6IGJ1ZmZlclR5cGUsXG4gICAgICAgIGNoYW5uZWxJRDogY2hhbm5lbCxcbiAgICAgICAgYmxvY2tzaXplOmJsb2Nrc2l6ZVxuICAgICAgfSk7XG4gICAgfVxuICB9XG5cbiAgc2VuZCh2YWx1ZSkge1xuICAgIGlmICh0aGlzLnJpbmdidWYuYXZhaWxhYmxlX3dyaXRlKCkgPiAxKSB7XG4gICAgICBpZiAodHlwZW9mKHZhbHVlKSA9PSBcIm51bWJlclwiKSB7XG4gICAgICAgIHRoaXMucmluZ2J1Zi5wdXNoKG5ldyBGbG9hdDY0QXJyYXkoW3ZhbHVlXSkpO1xuICAgICAgfWVsc2V7XG4gICAgICAgIGlmICh2YWx1ZS5sZW5ndGggPT0gdGhpcy5ibG9ja3NpemUpIHtcbiAgICAgICAgICB0aGlzLnJpbmdidWYucHVzaCh2YWx1ZSk7XG4gICAgICAgIH1lbHNlIGlmICh2YWx1ZS5sZW5ndGggPCB0aGlzLmJsb2Nrc2l6ZSkge1xuICAgICAgICAgIGxldCBuZXdWYWwgPSBuZXcgRmxvYXQ2NEFycmF5KHRoaXMuYmxvY2tzaXplKTtcbiAgICAgICAgICBmb3IobGV0IGkgaW4gdmFsdWUpIG5ld1ZhbFtpXSA9IHZhbHVlW2ldO1xuICAgICAgICAgIHRoaXMucmluZ2J1Zi5wdXNoKG5ld1ZhbCk7XG4gICAgICAgIH1lbHNle1xuICAgICAgICAgIHRoaXMucmluZ2J1Zi5wdXNoKHZhbHVlLnNsaWNlKDAsdGhpcy5ibG9ja3NpemUpKTtcbiAgICAgICAgfVxuICAgICAgfVxuICAgIH1cbiAgfVxuXG59XG5cbnZhciBjcmVhdGVPdXRwdXRDaGFubmVsID0gKGlkLCBibG9ja3NpemUpID0+IHtcbiAgcmV0dXJuIG5ldyBNTFNBQk91dHB1dFRyYW5zZHVjZXIoJ01MJywgaWQsIGJsb2Nrc2l6ZSk7XG59O1xuIiksbignXG52YXIgbG9hZFJlc3BvbmRlcnMgPSB7fTtcbnZhciBpbnB1dFNBQnM9e307XG52YXIgc2VtYSA9IHtcbiAgc2F2ZUYzMkFycmF5OiAobmFtZSwgdmFsKSA9PiB7XG4gICAgcG9zdE1lc3NhZ2Uoe1xuICAgICAgImZ1bmMiOiAic2F2ZSIsXG4gICAgICAibmFtZSI6IG5hbWUsXG4gICAgICAidmFsIjogdmFsXG4gICAgfSk7XG4gICAgcmV0dXJuIDA7XG4gIH0sXG4gIGxvYWRGMzJBcnJheTogKG5hbWUsIG9ubG9hZCkgPT4ge1xuICAgIHBvc3RNZXNzYWdlKHtcbiAgICAgICJmdW5jIjogImxvYWQiLFxuICAgICAgIm5hbWUiOiBuYW1lLFxuICAgIH0pO1xuICAgIGxvYWRSZXNwb25kZXJzW25hbWVdID0gb25sb2FkO1xuICAgIHJldHVybiAwO1xuICB9LFxuICBkb3dubG9hZDogKG5hbWUpID0+IHtcbiAgICBwb3N0TWVzc2FnZSh7XG4gICAgICAiZnVuYyI6ICJkb3dubG9hZCIsXG4gICAgICAibmFtZSI6IG5hbWUsXG4gICAgfSk7XG4gIH0sXG4gIHNlbmRDb2RlOiAoY29kZSkgPT4ge1xuICAgIHBvc3RNZXNzYWdlKHtcbiAgICAgICJmdW5jIjogInNlbmRjb2RlIixcbiAgICAgICJjb2RlIjogY29kZSxcbiAgICB9KTtcbiAgfSxcbiAgcGJjb3B5OiAobXNnKSA9PiB7XG4gICAgcG9zdE1lc3NhZ2Uoe1xuICAgICAgImZ1bmMiOiAicGJjb3B5IixcbiAgICAgICJtc2ciOiBtc2csXG4gICAgfSk7XG4gIH0sXG4gIHNlbmRCdWZmZXI6IChidWZmZXJOYW1lLGRhdGEpID0+IHtcbiAgICAgIHBvc3RNZXNzYWdlKHtcbiAgICAgICAgICAiZnVuYyI6ICJzZW5kYnVmIixcbiAgICAgICAgICAibmFtZSI6IGJ1ZmZlck5hbWUsXG4gICAgICAgICAgImRhdGEiOiBkYXRhXG4gICAgICB9KTtcbiAgfSxcbiAgZW52OiB7XG4gICAgc2F2ZUxvY2FsOiAobmFtZSkgPT4ge1xuICAgICAgcG9zdE1lc3NhZ2Uoe1xuICAgICAgICAgICAgImZ1bmMiOiAiZW52c2F2ZSIsXG4gICAgICAgICAgICAibmFtZSI6IG5hbWUsXG4gICAgICAgICAgICAic3RvcmFnZSI6ImxvY2FsIlxuICAgICAgICB9XG4gICAgICApXG4gICAgfSxcbiAgICBsb2FkTG9jYWw6IChuYW1lKSA9PiB7XG4gICAgICBwb3N0TWVzc2FnZSh7XG4gICAgICAgICAgICAiZnVuYyI6ICJlbnZsb2FkIixcbiAgICAgICAgICAgICJuYW1lIjogbmFtZSxcbiAgICAgICAgICAgICJzdG9yYWdlIjoibG9jYWwiXG4gICAgICAgIH1cbiAgICAgIClcbiAgICB9LFxuICAgIHNhdmVUb1BCOiAoKSA9PiB7XG4gICAgICBwb3N0TWVzc2FnZSh7XG4gICAgICAgICAgICAiZnVuYyI6ICJlbnZzYXZlIixcbiAgICAgICAgICAgICJzdG9yYWdlIjoicGFzdGVidWZmZXIiXG4gICAgICAgIH1cbiAgICAgIClcbiAgICB9LFxuICAgIGxvYWRHaXN0OiAoZ2lzdGlkKSA9PiB7XG4gICAgICBwb3N0TWVzc2FnZSh7XG4gICAgICAgICAgICAiZnVuYyI6ICJlbnZsb2FkIixcbiAgICAgICAgICAgICJuYW1lIjogZ2lzdGlkLFxuICAgICAgICAgICAgInN0b3JhZ2UiOiJnaXN0IlxuICAgICAgICB9XG4gICAgICApXG4gICAgfSxcblxuICB9LFxuICAvL3J1biBpbiB0aGUgRE9NXG4gIGRvbWV2YWw6IChjb2RlKSA9PiB7XG4gICAgcG9zdE1lc3NhZ2Uoe1xuICAgICAgICAgICJmdW5jIjogImRvbWV2YWwiLFxuICAgICAgICAgICJjb2RlIjogY29kZSxcbiAgICAgIH1cbiAgICApXG4gIH0sXG4gIHBlZXJpbmZvOiAoKSA9PiB7XG4gICAgcG9zdE1lc3NhZ2UgKHtcbiAgICAgICJmdW5jIjogInBlZXJpbmZvIlxuICAgIH0pO1xuICAgIGNvbnNvbGUubG9nKCJZb3VyIHBlZXIgSUQgaGFzIGJlZW4gY29waWVkIHRvIHRoZSBwYXN0ZSBidWZmZXIiKVxuICB9XG59O1xuJyl9fSgpLGUoKSxwb3N0TWVzc2FnZSh7aW5pdDohMH0pfWNhdGNoKG4pe2NvbnNvbGUuZXJyb3IoIkVSUk9SOiBvbiBpbXBvcnRTY3JpcHRzLCBnZXZhbEFsbCBhbmQgc2FiQ2hlY2tlciIpfWVsc2UgY29uc29sZS5lcnJvcigiRVJST1I6d29ya2VyOmluaXRXaXRoVVJMOiBJbnZhbGlkIFVSTCIpfWZ1bmN0aW9uIGUoKXt0cnl7Zm9yKGxldCBuIGluIGlucHV0U0FCcyl7bGV0IGU9aW5wdXRTQUJzW25dLnJiLmF2YWlsYWJsZV9yZWFkKCk7aWYoZSE9aW5wdXRTQUJzW25dLnJiLmNhcGFjaXR5JiZlPjApZm9yKGxldCBhPTA7YTxlO2ErPWlucHV0U0FCc1tuXS5ibG9ja3NpemUpe2xldCBlPW5ldyBGbG9hdDY0QXJyYXkoaW5wdXRTQUJzW25dLmJsb2Nrc2l6ZSk7aW5wdXRTQUJzW25dLnJiLnBvcChlKSxpbnB1dChuLGUpfX1zZXRUaW1lb3V0KGUsMjApfWNhdGNoKG4pe3NldFRpbWVvdXQoZSwxMDApfX1vbm1lc3NhZ2U9ZT0+e2lmKGUuZGF0YS51cmwmJm4oZS5kYXRhLnVybCksZS5kYXRhLmV2YWwpdHJ5e2lmKCFhKXZhciBhPWV2YWw7YShlLmRhdGEuZXZhbCl9Y2F0Y2gobil7Y29uc29sZS5lcnJvcihgRVJST1I6d29ya2VyOmdldmFsIGV4Y2VwdGlvbjogJHtufSBgLGUuZGF0YS5ldmFsKX1lbHNlIGlmKCJ2YWwiaW4gZS5kYXRhKXtsZXQgbj1lLmRhdGEudmFsO249SlNPTi5wYXJzZShgWyR7bn1dYCksbG9hZFJlc3BvbmRlcnNbZS5kYXRhLm5hbWVdKG4pLGRlbGV0ZSBsb2FkUmVzcG9uZGVyc1tlLmRhdGEubmFtZV19ZWxzZSBpZigibW9kZWwtaW5wdXQtZGF0YSI9PT1lLmRhdGEudHlwZSlpbnB1dChlLmRhdGEudmFsdWUsZS5kYXRhLmNoKTtlbHNlIGlmKGUuZGF0YS5zYWIpe2NvbnNvbGUubG9nKCJERUJVRzogU0FCIHJlY2VpdmVkIixlKTtsZXQgbj1lLmRhdGEuc2FiLGE9bmV3IFJpbmdCdWZmZXIobixGbG9hdDY0QXJyYXkpO2lucHV0U0FCc1tlLmRhdGEuY2hhbm5lbElEXT17c2FiOm4scmI6YSxibG9ja3NpemU6ZS5kYXRhLmJsb2Nrc2l6ZX0sY29uc29sZS5sb2coIk1MIixpbnB1dFNBQnMpfX19KCk7Cgo=","data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoid29ya2VyLmpzIiwic291cmNlcyI6WyJ3b3JrZXI6Ly93ZWItd29ya2VyL3NyYy9sZWFybmVyL3dvcmtlci5qcyJdLCJzb3VyY2VzQ29udGVudCI6WyJcInVzZSBzdHJpY3RcIjtcblxuICBmdW5jdGlvbiBnZXZhbEFsbCgpIHtcblx0XHRpZiAoIWdldmFsKSB7XG5cdFx0XHR2YXIgZ2V2YWwgPSBldmFsOyAvLyBwdXRzIGV2YWwgaW50byBnbG9iYWwgc2NvcGUgaHR0cHM6Ly9kZXZlbG9wZXIubW96aWxsYS5vcmcvZW4tVVMvZG9jcy9XZWIvSmF2YVNjcmlwdC9SZWZlcmVuY2UvR2xvYmFsX09iamVjdHMvZXZhbFxuXHRcdFx0Z2V2YWwoXCJ2YXIgaW5wdXQgPSAodmFsdWUsIGNoYW5uZWwpID0+IHt9XCIpO1xuXHRcdFx0Z2V2YWwoXG5cdFx0XHRcdFwidmFyIG91dHB1dCA9ICh2YWx1ZSxjaGFubmVsKSA9PiB7cG9zdE1lc3NhZ2Uoe2Z1bmM6J2RhdGEnLCB2YWw6dmFsdWUsIGNoOmNoYW5uZWx9KTt9XCJcblx0XHRcdCk7XG5cblx0XHRcdGdldmFsKGBcbnZhciBvdXRwdXRTQUJzID0ge307XG5jbGFzcyBNTFNBQk91dHB1dFRyYW5zZHVjZXIge1xuICBjb25zdHJ1Y3RvcihidWZmZXJUeXBlLCBjaGFubmVsLCBibG9ja3NpemUpIHtcbiAgICB0aGlzLmNoYW5uZWwgPSBjaGFubmVsO1xuICAgIHRoaXMuYmxvY2tzaXplID0gYmxvY2tzaXplO1xuXG4gICAgLy9jaGVjayBmb3IgZXhpc3RpbmcgY2hhbm5lbHNcbiAgICBpZiAoY2hhbm5lbCBpbiBvdXRwdXRTQUJzICYmIG91dHB1dFNBQnNbY2hhbm5lbF0uYmxvY2tzaXplID09IGJsb2Nrc2l6ZSkge1xuICAgICAgLy9yZXVzZSBleGlzdGluZ1xuICAgICAgdGhpcy5yaW5nYnVmID0gb3V0cHV0U0FCc1tjaGFubmVsXS5yYjtcbiAgICB9ZWxzZXtcbiAgICAgIC8vY3JlYXRlIGEgbmV3IFNBQiBhbmQgbm90aWZ5IHRoZSByZWNlaXZlclxuICAgICAgdGhpcy5zYWIgPSBSaW5nQnVmZmVyLmdldFN0b3JhZ2VGb3JDYXBhY2l0eSgzMiAqIGJsb2Nrc2l6ZSwgRmxvYXQ2NEFycmF5KTtcbiAgICAgIHRoaXMucmluZ2J1ZiA9IG5ldyBSaW5nQnVmZmVyKHRoaXMuc2FiLCBGbG9hdDY0QXJyYXkpO1xuICAgICAgb3V0cHV0U0FCc1tjaGFubmVsXSA9IHtyYjp0aGlzLnJpbmdidWYsIHNhYjp0aGlzLnNhYiwgY3JlYXRlZDpEYXRlLm5vdygpLCBibG9ja3NpemU6YmxvY2tzaXplfTtcblxuICAgICAgcG9zdE1lc3NhZ2Uoe1xuICAgICAgICBmdW5jOiAnc2FiJyxcbiAgICAgICAgdmFsdWU6IHRoaXMuc2FiLFxuICAgICAgICB0dHlwZTogYnVmZmVyVHlwZSxcbiAgICAgICAgY2hhbm5lbElEOiBjaGFubmVsLFxuICAgICAgICBibG9ja3NpemU6YmxvY2tzaXplXG4gICAgICB9KTtcbiAgICB9XG4gIH1cblxuICBzZW5kKHZhbHVlKSB7XG4gICAgaWYgKHRoaXMucmluZ2J1Zi5hdmFpbGFibGVfd3JpdGUoKSA+IDEpIHtcbiAgICAgIGlmICh0eXBlb2YodmFsdWUpID09IFwibnVtYmVyXCIpIHtcbiAgICAgICAgdGhpcy5yaW5nYnVmLnB1c2gobmV3IEZsb2F0NjRBcnJheShbdmFsdWVdKSk7XG4gICAgICB9ZWxzZXtcbiAgICAgICAgaWYgKHZhbHVlLmxlbmd0aCA9PSB0aGlzLmJsb2Nrc2l6ZSkge1xuICAgICAgICAgIHRoaXMucmluZ2J1Zi5wdXNoKHZhbHVlKTtcbiAgICAgICAgfWVsc2UgaWYgKHZhbHVlLmxlbmd0aCA8IHRoaXMuYmxvY2tzaXplKSB7XG4gICAgICAgICAgbGV0IG5ld1ZhbCA9IG5ldyBGbG9hdDY0QXJyYXkodGhpcy5ibG9ja3NpemUpO1xuICAgICAgICAgIGZvcihsZXQgaSBpbiB2YWx1ZSkgbmV3VmFsW2ldID0gdmFsdWVbaV07XG4gICAgICAgICAgdGhpcy5yaW5nYnVmLnB1c2gobmV3VmFsKTtcbiAgICAgICAgfWVsc2V7XG4gICAgICAgICAgdGhpcy5yaW5nYnVmLnB1c2godmFsdWUuc2xpY2UoMCx0aGlzLmJsb2Nrc2l6ZSkpO1xuICAgICAgICB9XG4gICAgICB9XG4gICAgfVxuICB9XG5cbn1cblxudmFyIGNyZWF0ZU91dHB1dENoYW5uZWwgPSAoaWQsIGJsb2Nrc2l6ZSkgPT4ge1xuICByZXR1cm4gbmV3IE1MU0FCT3V0cHV0VHJhbnNkdWNlcignTUwnLCBpZCwgYmxvY2tzaXplKTtcbn07XG5gKTtcblxuXHRcdFx0Z2V2YWwoYFxudmFyIGxvYWRSZXNwb25kZXJzID0ge307XG52YXIgaW5wdXRTQUJzPXt9O1xudmFyIHNlbWEgPSB7XG4gIHNhdmVGMzJBcnJheTogKG5hbWUsIHZhbCkgPT4ge1xuICAgIHBvc3RNZXNzYWdlKHtcbiAgICAgIFwiZnVuY1wiOiBcInNhdmVcIixcbiAgICAgIFwibmFtZVwiOiBuYW1lLFxuICAgICAgXCJ2YWxcIjogdmFsXG4gICAgfSk7XG4gICAgcmV0dXJuIDA7XG4gIH0sXG4gIGxvYWRGMzJBcnJheTogKG5hbWUsIG9ubG9hZCkgPT4ge1xuICAgIHBvc3RNZXNzYWdlKHtcbiAgICAgIFwiZnVuY1wiOiBcImxvYWRcIixcbiAgICAgIFwibmFtZVwiOiBuYW1lLFxuICAgIH0pO1xuICAgIGxvYWRSZXNwb25kZXJzW25hbWVdID0gb25sb2FkO1xuICAgIHJldHVybiAwO1xuICB9LFxuICBkb3dubG9hZDogKG5hbWUpID0+IHtcbiAgICBwb3N0TWVzc2FnZSh7XG4gICAgICBcImZ1bmNcIjogXCJkb3dubG9hZFwiLFxuICAgICAgXCJuYW1lXCI6IG5hbWUsXG4gICAgfSk7XG4gIH0sXG4gIHNlbmRDb2RlOiAoY29kZSkgPT4ge1xuICAgIHBvc3RNZXNzYWdlKHtcbiAgICAgIFwiZnVuY1wiOiBcInNlbmRjb2RlXCIsXG4gICAgICBcImNvZGVcIjogY29kZSxcbiAgICB9KTtcbiAgfSxcbiAgcGJjb3B5OiAobXNnKSA9PiB7XG4gICAgcG9zdE1lc3NhZ2Uoe1xuICAgICAgXCJmdW5jXCI6IFwicGJjb3B5XCIsXG4gICAgICBcIm1zZ1wiOiBtc2csXG4gICAgfSk7XG4gIH0sXG4gIHNlbmRCdWZmZXI6IChidWZmZXJOYW1lLGRhdGEpID0+IHtcbiAgICAgIHBvc3RNZXNzYWdlKHtcbiAgICAgICAgICBcImZ1bmNcIjogXCJzZW5kYnVmXCIsXG4gICAgICAgICAgXCJuYW1lXCI6IGJ1ZmZlck5hbWUsXG4gICAgICAgICAgXCJkYXRhXCI6IGRhdGFcbiAgICAgIH0pO1xuICB9LFxuICBlbnY6IHtcbiAgICBzYXZlTG9jYWw6IChuYW1lKSA9PiB7XG4gICAgICBwb3N0TWVzc2FnZSh7XG4gICAgICAgICAgICBcImZ1bmNcIjogXCJlbnZzYXZlXCIsXG4gICAgICAgICAgICBcIm5hbWVcIjogbmFtZSxcbiAgICAgICAgICAgIFwic3RvcmFnZVwiOlwibG9jYWxcIlxuICAgICAgICB9XG4gICAgICApXG4gICAgfSxcbiAgICBsb2FkTG9jYWw6IChuYW1lKSA9PiB7XG4gICAgICBwb3N0TWVzc2FnZSh7XG4gICAgICAgICAgICBcImZ1bmNcIjogXCJlbnZsb2FkXCIsXG4gICAgICAgICAgICBcIm5hbWVcIjogbmFtZSxcbiAgICAgICAgICAgIFwic3RvcmFnZVwiOlwibG9jYWxcIlxuICAgICAgICB9XG4gICAgICApXG4gICAgfSxcbiAgICBzYXZlVG9QQjogKCkgPT4ge1xuICAgICAgcG9zdE1lc3NhZ2Uoe1xuICAgICAgICAgICAgXCJmdW5jXCI6IFwiZW52c2F2ZVwiLFxuICAgICAgICAgICAgXCJzdG9yYWdlXCI6XCJwYXN0ZWJ1ZmZlclwiXG4gICAgICAgIH1cbiAgICAgIClcbiAgICB9LFxuICAgIGxvYWRHaXN0OiAoZ2lzdGlkKSA9PiB7XG4gICAgICBwb3N0TWVzc2FnZSh7XG4gICAgICAgICAgICBcImZ1bmNcIjogXCJlbnZsb2FkXCIsXG4gICAgICAgICAgICBcIm5hbWVcIjogZ2lzdGlkLFxuICAgICAgICAgICAgXCJzdG9yYWdlXCI6XCJnaXN0XCJcbiAgICAgICAgfVxuICAgICAgKVxuICAgIH0sXG5cbiAgfSxcbiAgLy9ydW4gaW4gdGhlIERPTVxuICBkb21ldmFsOiAoY29kZSkgPT4ge1xuICAgIHBvc3RNZXNzYWdlKHtcbiAgICAgICAgICBcImZ1bmNcIjogXCJkb21ldmFsXCIsXG4gICAgICAgICAgXCJjb2RlXCI6IGNvZGUsXG4gICAgICB9XG4gICAgKVxuICB9LFxuICBwZWVyaW5mbzogKCkgPT4ge1xuICAgIHBvc3RNZXNzYWdlICh7XG4gICAgICBcImZ1bmNcIjogXCJwZWVyaW5mb1wiXG4gICAgfSk7XG4gICAgY29uc29sZS5sb2coXCJZb3VyIHBlZXIgSUQgaGFzIGJlZW4gY29waWVkIHRvIHRoZSBwYXN0ZSBidWZmZXJcIilcbiAgfVxufTtcbmApO1xuXHRcdH1cblx0XHR0cnkge1xuXG5cdFx0XHQvLyBsZXQgZXZhbFJlcyA9IGdldmFsKFwidmFyIGNoYW5uZWwwID0gY3JlYXRlT3V0cHV0Q2hhbm5lbCgwLCAxKVwiKTtcblx0XHR9IGNhdGNoIChlcnIpIHtcblx0XHRcdGNvbnNvbGUuZXJyb3IoXCJFUlJPUjpldmFsOlwiLCBlcnIpO1xuXHRcdH1cblx0fVxuXG4gIGZ1bmN0aW9uIGluaXRXaXRoVVJMKHVybCl7XG4gICAgaWYobmV3IFVSTCh1cmwpKVxuICAgICAgdHJ5IHtcbiAgICAgICAgaW1wb3J0U2NyaXB0cyh1cmwgKyBcIi9sYWxvbGliLmpzXCIpO1xuICAgICAgICBpbXBvcnRTY3JpcHRzKHVybCArIFwiL3N2ZC5qc1wiKTtcbiAgICAgICAgaW1wb3J0U2NyaXB0cyh1cmwgKyBcIi9tbHdvcmtlcnNjcmlwdHMuanNcIik7XG4gICAgICAgIGltcG9ydFNjcmlwdHMoXG4gICAgICAgICAgXCJodHRwczovL2Nkbi5qc2RlbGl2ci5uZXQvbnBtL0B0ZW5zb3JmbG93L3RmanMvZGlzdC90Zi5taW4uanNcIlxuICAgICAgICApO1xuICAgICAgICBnZXZhbEFsbCgpO1xuICAgICAgICBzYWJDaGVja2VyKCk7XG5cbiAgICAgICAgcG9zdE1lc3NhZ2UoeyBpbml0OiB0cnVlIH0pO1xuICAgICAgICAvLyBjb25zb2xlLmxvZyhcbiAgICAgICAgLy8gICBcIkRFQlVHOndvcmtlcjogaW1wb3J0U2NyaXB0cywgZ2V2YWxBbGwgYW5kIHNhYkNoZWNrZXIgc3VjY2VlZGVkXCJcbiAgICAgICAgLy8gKTtcbiAgICAgIH0gY2F0Y2ggKGVycikge1xuICAgICAgICBjb25zb2xlLmVycm9yKFwiRVJST1I6IG9uIGltcG9ydFNjcmlwdHMsIGdldmFsQWxsIGFuZCBzYWJDaGVja2VyXCIpO1xuICAgICAgfVxuICAgIGVsc2VcbiAgICAgIGNvbnNvbGUuZXJyb3IoXCJFUlJPUjp3b3JrZXI6aW5pdFdpdGhVUkw6IEludmFsaWQgVVJMXCIpO1xuXG4gIH1cblxub25tZXNzYWdlID0gbSA9PiB7XG4gIC8vIGNvbnNvbGUubG9nKFwiREVCVUc6d29ya2VyOm9ubWVzc2FnZVwiKTtcblx0Ly8gY29uc29sZS5sb2cobSk7XG5cbiAgLy8gSW5pdCBtZXNzYWdlIG9ubHlcbiAgaWYobS5kYXRhLnVybCl7XG4gICAgaW5pdFdpdGhVUkwobS5kYXRhLnVybCk7XG4gIH1cblxuICBpZiAobS5kYXRhLmV2YWwpIHtcbiAgICB0cnkge1xuICAgICAgaWYgKCFnZXZhbCkgdmFyIGdldmFsID0gZXZhbDtcbiAgICAgIGxldCBldmFsUmVzID0gZ2V2YWwobS5kYXRhLmV2YWwpO1xuXG4gICAgICAvLyBjb25zb2xlLmxvZyhcIkRFQlVHOndvcmtlcjpnZXZhbFwiKTtcbiAgICAgIC8vIGNvbnNvbGUubG9nKGV2YWxSZXMpO1xuICAgIH0gY2F0Y2ggKGUpIHtcbiAgICAgIGNvbnNvbGUuZXJyb3IoYEVSUk9SOndvcmtlcjpnZXZhbCBleGNlcHRpb246ICR7ZX0gYCwgbS5kYXRhLmV2YWwpO1xuICAgIH1cblxuICB9IGVsc2UgaWYgKFwidmFsXCIgaW4gbS5kYXRhKSB7XG4gICAgLy8gY29uc29sZS5sb2coXCJERUJVRzptbC53b3JrZXI6b25tZXNzYWdlOnZhbFwiKTtcbiAgICBsZXQgdmFsID0gbS5kYXRhLnZhbDtcbiAgICAvLyBjb25zb2xlLmxvZyh2YWwpO1xuICAgIHZhbCA9IEpTT04ucGFyc2UoYFske3ZhbH1dYCk7XG4gICAgLy8gY29uc29sZS5sb2codmFsKTtcbiAgICAvLyBjb25zb2xlLmxvZyhsb2FkUmVzcG9uZGVycyk7XG4gICAgbG9hZFJlc3BvbmRlcnNbbS5kYXRhLm5hbWVdKHZhbCk7XG4gICAgZGVsZXRlIGxvYWRSZXNwb25kZXJzW20uZGF0YS5uYW1lXTtcblxuICB9IGVsc2UgaWYgKG0uZGF0YS50eXBlID09PSBcIm1vZGVsLWlucHV0LWRhdGFcIikge1xuXG4gICAgaW5wdXQobS5kYXRhLnZhbHVlLCBtLmRhdGEuY2gpO1xuXG4gIC8vIH0gZWxzZSBpZiAobS5kYXRhLnR5cGUgPT09IFwibW9kZWwtaW5wdXQtYnVmZmVyXCIpIHtcbiAgfSBlbHNlIGlmIChtLmRhdGEuc2FiKXtcblxuICAgIGNvbnNvbGUubG9nKFwiREVCVUc6IFNBQiByZWNlaXZlZFwiLCBtKTtcblxuICAgIGxldCBzYWIgPSBtLmRhdGEuc2FiO1xuICAgIGxldCByYiA9IG5ldyBSaW5nQnVmZmVyKHNhYiwgRmxvYXQ2NEFycmF5KTtcblxuICAgIGlucHV0U0FCc1ttLmRhdGEuY2hhbm5lbElEXSA9IHtcbiAgICAgIHNhYixcbiAgICAgIHJiLFxuICAgICAgYmxvY2tzaXplOiBtLmRhdGEuYmxvY2tzaXplXG4gICAgfTtcblxuICAgIGNvbnNvbGUubG9nKFwiTUxcIiwgaW5wdXRTQUJzKTtcbiAgfVxufTtcblxuZnVuY3Rpb24gc2FiQ2hlY2tlcigpIHtcbiAgdHJ5IHtcbiAgICAvLyBjb25zb2xlLmxvZyhpbnB1dFNBQnMpO1xuICAgIGZvciAobGV0IHYgaW4gaW5wdXRTQUJzKSB7XG4gICAgICBsZXQgYXZhaWwgPSBpbnB1dFNBQnNbdl0ucmIuYXZhaWxhYmxlX3JlYWQoKTtcbiAgICAgIC8vIGNvbnNvbGUubG9nKGF2YWlsLCBpbnB1dFNBQnNbdl0ucmIuY2FwYWNpdHksIGlucHV0U0FCc1t2XS5ibG9ja3NpemUpO1xuICAgICAgaWYgKGF2YWlsICE9IGlucHV0U0FCc1t2XS5yYi5jYXBhY2l0eSAmJiBhdmFpbCA+IDApIHtcbiAgICAgICAgZm9yIChsZXQgaSA9IDA7IGkgPCBhdmFpbDsgaSArPSBpbnB1dFNBQnNbdl0uYmxvY2tzaXplKSB7XG4gICAgICAgICAgbGV0IHZhbCA9IG5ldyBGbG9hdDY0QXJyYXkoaW5wdXRTQUJzW3ZdLmJsb2Nrc2l6ZSk7XG4gICAgICAgICAgaW5wdXRTQUJzW3ZdLnJiLnBvcCh2YWwpO1xuICAgICAgICAgIC8vIGNvbnNvbGUubG9nKHZhbCk7XG4gICAgICAgICAgaW5wdXQodiwgdmFsKTtcbiAgICAgICAgfVxuICAgICAgfVxuICAgIH1cbiAgICBzZXRUaW1lb3V0KHNhYkNoZWNrZXIsIDIwKTtcbiAgfSBjYXRjaCAoZXJyb3IpIHtcbiAgICAvLyBjb25zb2xlLmxvZyhlcnJvcik7XG4gICAgc2V0VGltZW91dChzYWJDaGVja2VyLCAxMDApO1xuICB9XG59XG5cbiJdLCJuYW1lcyI6WyJpbml0V2l0aFVSTCIsInVybCIsIlVSTCIsImltcG9ydFNjcmlwdHMiLCJnZXZhbCIsImV2YWwiLCJnZXZhbEFsbCIsInNhYkNoZWNrZXIiLCJwb3N0TWVzc2FnZSIsImluaXQiLCJlcnIiLCJjb25zb2xlIiwiZXJyb3IiLCJ2IiwiaW5wdXRTQUJzIiwiYXZhaWwiLCJyYiIsImF2YWlsYWJsZV9yZWFkIiwiY2FwYWNpdHkiLCJpIiwiYmxvY2tzaXplIiwidmFsIiwiRmxvYXQ2NEFycmF5IiwicG9wIiwiaW5wdXQiLCJzZXRUaW1lb3V0Iiwib25tZXNzYWdlIiwibSIsImRhdGEiLCJlIiwiSlNPTiIsInBhcnNlIiwibG9hZFJlc3BvbmRlcnMiLCJuYW1lIiwidHlwZSIsInZhbHVlIiwiY2giLCJzYWIiLCJsb2ciLCJSaW5nQnVmZmVyIiwiY2hhbm5lbElEIl0sIm1hcHBpbmdzIjoieUJBc0tFLFNBQVNBLEVBQVlDLEdBQ25CLEdBQUcsSUFBSUMsSUFBSUQsR0FDVCxJQUNFRSxjQUFjRixFQUFNLGVBQ3BCRSxjQUFjRixFQUFNLFdBQ3BCRSxjQUFjRixFQUFNLHVCQUNwQkUsY0FDRSxnRUEzS1IsV0FDQSxJQUFLQyxFQUFPLENBQ1gsSUFBSUEsRUFBUUMsS0FDWkQsRUFBTSxzQ0FDTkEsRUFDQyx3RkFHREEsRUFBTSw4L0NBb0ROQSxFQUFNLGd4REFpSERFLEdBQ0FDLElBRUFDLFlBQVksQ0FBRUMsTUFBTSxJQUlwQixNQUFPQyxHQUNQQyxRQUFRQyxNQUFNLHlEQUdoQkQsUUFBUUMsTUFBTSx5Q0F3RHBCLFNBQVNMLElBQ1AsSUFFRSxJQUFLLElBQUlNLEtBQUtDLFVBQVcsQ0FDdkIsSUFBSUMsRUFBUUQsVUFBVUQsR0FBR0csR0FBR0MsaUJBRTVCLEdBQUlGLEdBQVNELFVBQVVELEdBQUdHLEdBQUdFLFVBQVlILEVBQVEsRUFDL0MsSUFBSyxJQUFJSSxFQUFJLEVBQUdBLEVBQUlKLEVBQU9JLEdBQUtMLFVBQVVELEdBQUdPLFVBQVcsQ0FDdEQsSUFBSUMsRUFBTSxJQUFJQyxhQUFhUixVQUFVRCxHQUFHTyxXQUN4Q04sVUFBVUQsR0FBR0csR0FBR08sSUFBSUYsR0FFcEJHLE1BQU1YLEVBQUdRLElBSWZJLFdBQVdsQixFQUFZLElBQ3ZCLE1BQU9LLEdBRVBhLFdBQVdsQixFQUFZLE1BdEUzQm1CLFVBQVlDLElBU1YsR0FKR0EsRUFBRUMsS0FBSzNCLEtBQ1JELEVBQVkyQixFQUFFQyxLQUFLM0IsS0FHakIwQixFQUFFQyxLQUFLdkIsS0FDVCxJQUNFLElBQUtELEVBQU8sSUFBSUEsRUFBUUMsS0FDVkQsRUFBTXVCLEVBQUVDLEtBQUt2QixNQUkzQixNQUFPd0IsR0FDUGxCLFFBQVFDLE1BQU0saUNBQWlDaUIsS0FBTUYsRUFBRUMsS0FBS3ZCLFdBR3pELEdBQUksUUFBU3NCLEVBQUVDLEtBQU0sQ0FFMUIsSUFBSVAsRUFBTU0sRUFBRUMsS0FBS1AsSUFFakJBLEVBQU1TLEtBQUtDLE1BQU0sSUFBSVYsTUFHckJXLGVBQWVMLEVBQUVDLEtBQUtLLE1BQU1aLFVBQ3JCVyxlQUFlTCxFQUFFQyxLQUFLSyxXQUV4QixHQUFvQixxQkFBaEJOLEVBQUVDLEtBQUtNLEtBRWhCVixNQUFNRyxFQUFFQyxLQUFLTyxNQUFPUixFQUFFQyxLQUFLUSxTQUd0QixHQUFJVCxFQUFFQyxLQUFLUyxJQUFJLENBRXBCMUIsUUFBUTJCLElBQUksc0JBQXVCWCxHQUVuQyxJQUFJVSxFQUFNVixFQUFFQyxLQUFLUyxJQUNickIsRUFBSyxJQUFJdUIsV0FBV0YsRUFBS2YsY0FFN0JSLFVBQVVhLEVBQUVDLEtBQUtZLFdBQWEsQ0FDNUJILElBQUFBLEVBQ0FyQixHQUFBQSxFQUNBSSxVQUFXTyxFQUFFQyxLQUFLUixXQUdwQlQsUUFBUTJCLElBQUksS0FBTXhCIn0=",!1);class Learner{constructor(){this.dispatcher=new Dispatcher}addEventListener(e,t){if(!(this.dispatcher&&e&&t))throw new Error("Error adding event listener to Learner");this.dispatcher.addEventListener(e,t)}removeEventListner(e,t){if(!(this.dispatcher&&e&&t))throw new Error("Error removing event listener to Learner");this.dispatcher.removeEventListener(e,t)}async init(e){return this.worker=new WorkerFactory,new Promise(((t,o)=>{let r={};this.worker&&new URL(e)&&(this.worker.postMessage({url:e}),this.worker.onerror=this.onErrorHandler,this.worker.onmessage=e=>{r=e.data.init,console.info("running Learner"),t(r),this.worker.onmessage=this.onMessageHandler})}))}onMessageHandler=e=>{this.dispatcher.dispatch("onSharedBuffer",e.data),console.log("onSharedBuffer"),console.log(e)};onErrorHandler=e=>{console.log("onError"),console.log(e)};eval(e){this.worker&&e&&this.worker.postMessage({eval:e})}createSharedBuffer(e){if(!this.worker||!e.sab)throw new Error("Error creating shared buffer in Learner");this.worker.postMessage({sab:e.sab,blocksize:e.blocksize,channelID:e.channelID})}evalBlock(e){let t=e.indexOf("\n");"//--DOM"==e.substr(0,t)?(e=e.substr(t),evalDomCode(e),addToHistory("dom-history-",e)):(this.worker.postMessage({eval:e}),window.localStorage.setItem("modelEditorValue",codeMirror.getValue()),addToHistory("model-history-",e))}terminate(){this.worker.terminate(),this.worker=null}}function getBlock(e){if(e){let t=e.getCursor(),o=t.line,r=e.lastLine();for(;o<r;){if(/___+/.test(e.getLine(o))){r=o-1;break}o++}o=t.line;let n=-1;for(;o>=0;){if(/___+/.test(e.getLine(o))){n=o;break}o--}return n>-1&&n++,e.getRange({line:n,ch:0},{line:r+1,ch:0})}}exports.ASTreeToJavascript=IR,exports.Engine=Engine,exports.Learner=Learner,exports.compile=compile,exports.compileGrammar=compileGrammar,exports.getBlock=getBlock,exports.getParserModuleExports=getParserModuleExports,exports.mooo=moo.mooo,exports.nearley=nearley.nearley,exports.semaa=sema.semaa,Object.defineProperty(exports,"__esModule",{value:!0})}));
//# sourceMappingURL=sema-engine.js.map
